<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — Seleccionar códigos del catálogo</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0b0f24;
      --panel:#ffffff;
      --ink:#0e1b2a;
      --muted:#6b7b91;
      --brand:#0B4912;
      --ring:#b7ffd1;
    }
    html,body{height:100%}
    body{background:var(--bg); color:#eaf2ff; margin:0;}
    .wrap{max-width:1200px; margin:0 auto; padding:28px 16px 72px;}

    .header h1{font-size:1.25rem; margin:0;}
    .sub{color:rgba(234,242,255,.65); font-size:.95rem}

    .panel{
      background:var(--panel); color:var(--ink);
      border:1px solid rgba(0,0,0,.06);
      border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.08);
      padding:16px;
    }

    /* Chips de filtro */
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border:1px solid #e5e7eb; background:#fff; color:#0e1b2a;
      padding:6px 10px; border-radius:999px; font-weight:600; font-size:.9rem;
      cursor:pointer; user-select:none;
    }
    .chip.active{ border-color: var(--brand); box-shadow:0 0 0 3px var(--ring); }

    /* Barra de herramientas */
    .toolbar{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .muted{color:var(--muted)}

    .sorter .btn{
      --bs-btn-border-color:#e5e7eb;
      --bs-btn-color:#0e1b2a;
      --bs-btn-bg:#fff;
      --bs-btn-hover-border-color:#cbd5e1;
      --bs-btn-hover-bg:#f8fafc;
      --bs-btn-active-bg:#e2e8f0;
    }

    /* Grid de tarjetas */
    .grid{
      display:grid; gap:12px;
      grid-template-columns: repeat( auto-fill, minmax(240px, 1fr) );
      margin-top:12px;
    }
    .card-code{
      background:#fff; color:var(--ink);
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px; padding:12px 12px 14px;
      display:flex; gap:8px; flex-direction:column;
      cursor:pointer; transition: transform .08s ease, box-shadow .08s ease, border-color .08s ease;
      position:relative; outline:none;
      min-height:120px;
    }
    .card-code:hover{ transform: translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.08); }
    .card-code.selected{
      border-color: var(--brand);
      box-shadow: 0 0 0 3px var(--ring), 0 8px 24px rgba(11,73,18,.15);
    }

    .badge-usage{ background:#f1f5f9; color:#0e1b2a; }
    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-weight:800; letter-spacing:.2px; font-size:1.05rem;
    }
    .desc{color:#31465a; min-height:2.6em}
    .tipo{font-size:.8rem; color:#4b5d72}

    /* Barra de selección */
    .selection-bar{
      position: sticky; bottom: 16px; z-index: 50; margin-top:16px; display:none;
    }
    .selection-bar.show{display:block;}
    .selection-panel{
      background:#0f1a2c; color:#eaf2ff; border:1px solid rgba(255,255,255,.08);
      border-radius:14px; padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    .btn-brand{
      background:var(--brand); color:#fff; border:none; border-radius:10px;
      padding:8px 12px; font-weight:700;
    }
    .btn-brand:hover{ filter:brightness(1.05); }

    /* Empty & skeletons */
    .empty{ text-align:center; color:var(--muted); padding:28px 6px; }
    .skeleton{
      height:120px; border-radius:14px; background:linear-gradient(90deg,#edf2f7, #f8fafc, #edf2f7);
      background-size:200% 100%; animation: shimmer 1s infinite linear;
    }
    @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    /* Botón cargar más */
    .loadmore-wrap{display:flex; justify-content:center; margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header mb-3">
      <h1>Catálogo de códigos</h1>
      <div class="sub">Haz clic para seleccionar códigos “madre” (sin buscador, explora visualmente).</div>
    </div>

    <div class="panel">
      <div class="toolbar mb-2">
        <div class="chips" id="chips">
          <span class="chip active" data-filter="todos">Todos</span>
          <span class="chip" data-filter="Asesoría">Asesoría</span>
          <span class="chip" data-filter="Imprenta">Imprenta</span>
        </div>
        <div class="sorter">
          <div class="btn-group btn-group-sm" role="group" aria-label="Ordenar">
            <button class="btn btn-outline-secondary" id="ordUso">Ordenar por uso</button>
            <button class="btn btn-outline-secondary" id="ordCodigo">Ordenar por código</button>
          </div>
        </div>
      </div>

      <div id="grid" class="grid" aria-live="polite">
        <!-- skeletons iniciales -->
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>

      <div class="loadmore-wrap">
        <button id="btnMas" class="btn btn-outline-secondary btn-sm d-none">Mostrar más</button>
      </div>

      <div id="empty" class="empty d-none">Sin resultados para este filtro.</div>

      <div id="selBar" class="selection-bar">
        <div class="selection-panel">
          <div><strong id="selCount">0</strong> código(s) seleccionados</div>
          <div class="d-flex gap-2">
            <button id="btnQuitarSel" class="btn btn-outline-light btn-sm">Quitar selección</button>
            <button id="btnContinuar" class="btn-brand">Continuar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Ajusta si usas otro endpoint:
  const API_LIST = 'api/dashboard_codigos.php?tipos=Asesoría,Imprenta&limit=1000';

  const state = {
    all: [],        // todo lo cargado del endpoint
    working: [],    // después de filtrar por tipo
    page: 0,
    pageSize: 36,
    selected: new Set(),
    filter: 'todos',    // 'todos' | 'Asesoría' | 'Imprenta'
    sortBy: 'uso'       // 'uso' | 'codigo'
  };

  const $ = (s, d=document)=>d.querySelector(s);
  const $$ = (s, d=document)=>Array.from(d.querySelectorAll(s));
  const grid = $('#grid');
  const empty = $('#empty');
  const btnMas = $('#btnMas');
  const selBar = $('#selBar');
  const selCount = $('#selCount');
  const btnQuitarSel = $('#btnQuitarSel');
  const btnContinuar = $('#btnContinuar');

  function esc(s){ return (s??'').toString().replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

  function normalizeItem(raw){
    return {
      tipo: raw['Tipo de Clasificación'] ?? raw.tipo ?? '',
      codigo: (raw['Codigo de Clasificación'] ?? raw.codigo ?? '').toString(),
      descripcion: raw['Descripción de Clasificación'] ?? raw.descripcion ?? '',
      usage: Number(raw.usage_count ?? raw.usage ?? 0) || 0
    };
  }

  function applyFilterAndSort(){
    // Filtro por tipo
    state.working = state.all.filter(it=>{
      if (state.filter === 'todos') return true;
      return it.tipo === state.filter;
    });
    // Orden
    if (state.sortBy === 'uso') {
      state.working.sort((a,b)=> b.usage - a.usage || a.codigo.localeCompare(b.codigo));
    } else {
      state.working.sort((a,b)=> a.codigo.localeCompare(b.codigo));
    }
    // Reinicia paginación
    state.page = 0;
  }

  function renderPage(){
    const start = state.page * state.pageSize;
    const slice = state.working.slice(start, start + state.pageSize);

    if (state.page === 0) {
      grid.innerHTML = '';
    }
    if (slice.length === 0 && state.page === 0) {
      empty.classList.remove('d-none');
      btnMas.classList.add('d-none');
      return;
    }
    empty.classList.add('d-none');

    const html = slice.map(it=>{
      const isSel = state.selected.has(it.codigo);
      return `
        <button type="button" class="card-code ${isSel?'selected':''}"
                data-codigo="${esc(it.codigo)}" data-tipo="${esc(it.tipo)}" aria-pressed="${isSel}">
          <div class="d-flex justify-content-between align-items-start">
            <span class="code">${esc(it.codigo)}</span>
            <span class="badge rounded-pill badge-usage">${it.usage}</span>
          </div>
          <div class="desc">${esc(it.descripcion || '—')}</div>
          <div class="tipo">${esc(it.tipo || '')}</div>
        </button>`;
    }).join('');
    grid.insertAdjacentHTML('beforeend', html);

    // Bind de la página agregada
    $$('.card-code', grid).slice(-slice.length).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const codigo = btn.getAttribute('data-codigo');
        if(state.selected.has(codigo)){
          state.selected.delete(codigo);
          btn.classList.remove('selected');
        } else {
          state.selected.add(codigo);
          btn.classList.add('selected');
        }
        updateSelectionBar();
      });
    });

    // Mostrar / ocultar “Mostrar más”
    const hasMore = (start + slice.length) < state.working.length;
    btnMas.classList.toggle('d-none', !hasMore);
  }

  function updateSelectionBar(){
    const n = state.selected.size;
    selCount.textContent = n;
    selBar.classList.toggle('show', n>0);
  }

  async function load(){
    try{
      const r = await fetch(API_LIST, {cache:'no-store'});
      const raw = await r.json();
      if(!raw.ok) throw new Error(raw.error || 'No se pudo cargar el catálogo');
      const items = Array.isArray(raw.items) ? raw.items : (raw.data || []);
      state.all = items.map(normalizeItem).filter(x=>x.codigo);
      applyFilterAndSort();
      renderPage();
    }catch(err){
      grid.innerHTML = '';
      empty.innerHTML = 'No se pudo cargar el catálogo.<br><small class="muted">'+esc(err.message||String(err))+'</small>';
      empty.classList.remove('d-none');
    }
  }

  // Filtros por chips
  $('#chips').addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip');
    if(!chip) return;
    $$('.chip', $('#chips')).forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    state.filter = chip.getAttribute('data-filter');
    applyFilterAndSort();
    renderPage();
  });

  // Orden
  $('#ordUso').addEventListener('click', ()=>{
    state.sortBy = 'uso';
    applyFilterAndSort();
    renderPage();
  });
  $('#ordCodigo').addEventListener('click', ()=>{
    state.sortBy = 'codigo';
    applyFilterAndSort();
    renderPage();
  });

  // Mostrar más
  btnMas.addEventListener('click', ()=>{
    state.page += 1;
    renderPage();
  });

  // Selección
  btnQuitarSel.addEventListener('click', ()=>{
    state.selected.clear();
    updateSelectionBar();
    $$('.card-code.selected', grid).forEach(el=>el.classList.remove('selected'));
  });
  btnContinuar.addEventListener('click', ()=>{
    const seleccionados = Array.from(state.selected);
    if(!seleccionados.length){
      alert('Selecciona al menos un código.');
      return;
    }
    // Aquí luego puedes navegar o guardar en URL/Storage:
    console.log('Códigos seleccionados:', seleccionados);
    alert(`Seleccionados: ${seleccionados.join(', ')}`);
  });

  load();
</script>
</body>
</html>
