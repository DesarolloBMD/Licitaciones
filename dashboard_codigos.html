<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — Seleccionar códigos del catálogo</title>

  <!-- Bootstrap (opcional, solo para tipografía y utilidades) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0b0f24;
      --panel:#ffffff;
      --ink:#0e1b2a;
      --muted:#6b7b91;
      --brand:#0B4912;
      --brand-2:#126a1a;
      --ring:#b7ffd1;
    }
    html,body{height:100%}
    body{background:var(--bg); color:#eaf2ff; margin:0;}
    .wrap{max-width:1100px; margin:0 auto; padding:28px 16px 56px;}

    .header h1{font-size:1.25rem; margin:0;}
    .sub{color:rgba(234,242,255,.65); font-size:.95rem}

    .panel{
      background:var(--panel); color:var(--ink);
      border:1px solid rgba(0,0,0,.06);
      border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.08);
      padding:16px;
    }

    /* Filtros */
    .toolbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .toolbar .search{flex:1 1 280px; min-width:240px}
    .text-muted-ink{color:var(--muted)!important}

    /* Grid de tarjetas */
    .grid{
      display:grid; gap:12px;
      grid-template-columns: repeat( auto-fill, minmax(250px, 1fr) );
      margin-top:12px;
    }
    .card-code{
      background:#fff; color:var(--ink);
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px; padding:12px 12px 14px;
      display:flex; gap:8px; flex-direction:column;
      cursor:pointer; transition: transform .08s ease, box-shadow .08s ease, border-color .08s ease;
      position:relative; outline:none;
    }
    .card-code:hover{ transform: translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.08); }
    .card-code.selected{
      border-color: var(--brand);
      box-shadow: 0 0 0 3px var(--ring), 0 8px 24px rgba(11,73,18,.15);
    }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      background:#f1f5f9; color:#0e1b2a; border-radius:999px;
      padding:3px 8px; font-size:.78rem; font-weight:600;
    }
    .pill .dot{
      width:8px; height:8px; border-radius:50%;
      background:var(--brand);
    }

    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-weight:700; letter-spacing:.2px;
    }
    .desc{color:#31465a}
    .tipo{font-size:.8rem; color:#4b5d72}

    /* Barra de selección */
    .selection-bar{
      position: sticky; bottom: 12px; z-index: 50;
      display:none; margin-top:16px;
    }
    .selection-bar.show{display:block;}
    .selection-panel{
      background:#0f1a2c; color:#eaf2ff; border:1px solid rgba(255,255,255,.08);
      border-radius:14px; padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    .btn-brand{
      background:var(--brand); color:#fff; border:none; border-radius:10px;
      padding:8px 12px; font-weight:600;
    }
    .btn-brand:hover{ filter:brightness(1.05); }

    /* Empty & loading */
    .empty{
      text-align:center; color:var(--muted); padding:28px 6px;
    }
    .skeleton{
      height:88px; border-radius:14px; background:linear-gradient(90deg,#edf2f7, #f8fafc, #edf2f7);
      background-size:200% 100%; animation: shimmer 1s infinite linear;
    }
    @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header mb-3">
      <h1>Catálogo de códigos</h1>
      <div class="sub">Selecciona uno o varios códigos “madre” del catálogo para analizarlos después.</div>
    </div>

    <div class="panel">
      <div class="toolbar mb-2">
        <input id="txtBuscar" class="form-control search" placeholder="Buscar por código o descripción…" />
        <button id="btnLimpiar" class="btn btn-outline-secondary btn-sm">Limpiar</button>
      </div>

      <div id="grid" class="grid" aria-live="polite">
        <!-- skeletons iniciales -->
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>

      <div id="empty" class="empty d-none">Sin resultados.</div>

      <div id="selBar" class="selection-bar">
        <div class="selection-panel">
          <div><strong id="selCount">0</strong> código(s) seleccionados</div>
          <div class="d-flex gap-2">
            <button id="btnQuitarSel" class="btn btn-outline-light btn-sm">Quitar selección</button>
            <button id="btnContinuar" class="btn-brand">Continuar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const API_LIST = 'api/catalogo_codigos_importar.php?accion=list';
  const state = {
    raw: [],
    filtered: [],
    selected: new Set(),
    q: ''
  };

  const $ = (s, d=document)=>d.querySelector(s);
  const $$ = (s, d=document)=>Array.from(d.querySelectorAll(s));
  const grid = $('#grid');
  const empty = $('#empty');
  const txtBuscar = $('#txtBuscar');
  const btnLimpiar = $('#btnLimpiar');
  const selBar = $('#selBar');
  const selCount = $('#selCount');
  const btnQuitarSel = $('#btnQuitarSel');
  const btnContinuar = $('#btnContinuar');

  function esc(s){ return (s??'').toString().replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

  function normalizeItem(raw){
    return {
      tipo: raw['Tipo de Clasificación'] ?? raw.tipo ?? '',
      codigo: raw['Codigo de Clasificación'] ?? raw.codigo ?? '',
      descripcion: raw['Descripción de Clasificación'] ?? raw.descripcion ?? '',
      usage: raw.usage_count ?? raw.usage ?? null
    };
  }

  function applyFilters(){
    const q = state.q.trim().toLowerCase();
    state.filtered = state.raw.filter(it=>{
      if(!q) return true;
      return (it.codigo.toLowerCase().includes(q) || it.descripcion.toLowerCase().includes(q));
    });
    render();
  }

  function render(){
    if(!state.filtered.length){
      grid.innerHTML = '';
      empty.classList.remove('d-none');
      return;
    }
    empty.classList.add('d-none');

    const html = state.filtered.map(it=>{
      const id = `${it.tipo}__${it.codigo}`.replace(/\s+/g,'_');
      const isSel = state.selected.has(it.codigo);
      return `
        <button type="button" class="card-code ${isSel?'selected':''}" data-codigo="${esc(it.codigo)}" data-tipo="${esc(it.tipo)}" id="${esc(id)}" aria-pressed="${isSel}">
          <div class="d-flex justify-content-between align-items-start">
            <span class="pill"><span class="dot"></span>${esc(it.codigo)}</span>
            ${it.usage!=null ? `<span class="badge text-bg-light">${it.usage}</span>`:''}
          </div>
          <div class="desc">${esc(it.descripcion || '—')}</div>
          <div class="tipo">${esc(it.tipo || '')}</div>
        </button>`;
    }).join('');
    grid.innerHTML = html;

    // bind click
    $$('.card-code', grid).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const codigo = btn.getAttribute('data-codigo');
        if(state.selected.has(codigo)){ state.selected.delete(codigo); btn.classList.remove('selected'); }
        else { state.selected.add(codigo); btn.classList.add('selected'); }
        updateSelectionBar();
      });
    });
  }

  function updateSelectionBar(){
    const n = state.selected.size;
    selCount.textContent = n;
    selBar.classList.toggle('show', n>0);
  }

  async function load(){
    try{
      // deja los skeletons un momento
      const r = await fetch(API_LIST, {cache:'no-store'});
      const raw = await r.json();
      if(!raw.ok) throw new Error(raw.error || 'No se pudo cargar el catálogo');
      const items = Array.isArray(raw.items) ? raw.items : (raw.data || []);
      state.raw = items.map(normalizeItem).filter(x=>x.codigo);
      state.filtered = [...state.raw];
      render();
    }catch(err){
      // En caso de error, limpia skeletons y muestra vacío con mensaje
      grid.innerHTML = '';
      empty.innerHTML = 'No se pudo cargar el catálogo.<br><small class="text-muted-ink">'+esc(err.message||String(err))+'</small>';
      empty.classList.remove('d-none');
    }
  }

  // Eventos
  txtBuscar.addEventListener('input', (e)=>{ state.q = e.target.value; applyFilters(); });
  btnLimpiar.addEventListener('click', ()=>{
    txtBuscar.value = ''; state.q = ''; applyFilters();
  });
  btnQuitarSel.addEventListener('click', ()=>{
    state.selected.clear();
    updateSelectionBar();
    // quitar estado visual
    $$('.card-code.selected', grid).forEach(el=>el.classList.remove('selected'));
  });
  btnContinuar.addEventListener('click', ()=>{
    // Por ahora, solo mostramos en consola los seleccionados.
    // Luego lo usaremos para pedir datos a Procedimientos Adjudicados.
    console.log('Códigos seleccionados:', Array.from(state.selected));
    alert(`Seleccionados: ${Array.from(state.selected).join(', ')}`);
  });

  load();
</script>
</body>
</html>