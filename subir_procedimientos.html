<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Importador de Procedimientos Adjudicados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body {
      background: #0b0f24;
      color: #eaf2ff;
      font-family: system-ui, sans-serif;
      padding: 40px 20px;
    }
    .container {
      max-width: 900px;
    }
    .panel {
      background: #ffffff;
      color: #0e1b2a;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,.15);
      padding: 20px;
    }
    .btn-brand {
      background-color: #0B4912;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
    }
    .btn-brand:hover {
      background-color: #126a1a;
    }
    .progress {
      height: 20px;
      border-radius: 10px;
      background-color: #e1e7ec;
    }
    .progress-bar {
      background-color: #0B4912;
    }
    .table thead {
      background: #f1f3f5;
    }
  </style>
</head>
<body>

<div class="container">
  <h2 class="mb-3">Importador de Procedimientos Adjudicados</h2>
  <p class="text-light mb-4">Bienvenido al importador del Departamento de Licitaciones.  
  Por favor, cargue un archivo con extensión <code>.csv</code> o <code>.txt</code> con los encabezados requeridos.</p>

  <div class="panel">
    <div class="mb-3">
      <label class="form-label fw-semibold">Archivo (.csv o .txt)</label>
      <input type="file" class="form-control" id="archivo" accept=".csv,.txt" required>
      <div class="form-text">
        Encabezado esperado: <code>Mes de Descarga, CEDULA, INSTITUCION, ANO, NUMERO_PROCEDIMIENTO, ...</code>
      </div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button id="btnSubir" class="btn btn-brand">Subir e importar</button>
      <button id="btnCancelar" class="btn btn-outline-secondary">Limpiar</button>
    </div>

    <div id="statusArea" class="mt-4 d-none">
      <h6 class="fw-bold">Progreso de importación:</h6>
      <div class="progress mt-2 mb-2">
        <div id="barraProgreso" class="progress-bar" role="progressbar" style="width:0%">0%</div>
      </div>
      <small id="cronometro" class="text-muted"></small>
    </div>

    <hr class="my-4">

    <h5 class="fw-bold">Historial de importaciones</h5>
    <div class="table-responsive mt-3">
      <table class="table table-sm table-bordered align-middle" id="tablaLogs">
        <thead>
          <tr>
            <th>Archivo</th>
            <th>Total</th>
            <th>Insertados</th>
            <th>Saltados</th>
            <th>Inicio</th>
            <th>Fin</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" class="text-center text-muted">Cargando historial…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API_URL = 'api/procedimientos_importar.php';

const archivo = document.getElementById('archivo');
const btnSubir = document.getElementById('btnSubir');
const btnCancelar = document.getElementById('btnCancelar');
const barraProgreso = document.getElementById('barraProgreso');
const statusArea = document.getElementById('statusArea');
const cronometro = document.getElementById('cronometro');
const tablaLogs = document.querySelector('#tablaLogs tbody');

let timer, segundos = 0;

function iniciarCronometro() {
  segundos = 0;
  cronometro.textContent = '0 s';
  timer = setInterval(() => {
    segundos++;
    cronometro.textContent = segundos + ' s';
  }, 1000);
}

function detenerCronometro() {
  clearInterval(timer);
}

function actualizarBarra(porcentaje) {
  barraProgreso.style.width = porcentaje + '%';
  barraProgreso.textContent = porcentaje + '%';
}

function limpiarFormulario() {
  archivo.value = '';
  statusArea.classList.add('d-none');
  barraProgreso.style.width = '0%';
  barraProgreso.textContent = '0%';
  cronometro.textContent = '';
}

async function cargarHistorial() {
  try {
    const r = await fetch(API_URL + '?accion=logs', { cache: 'no-store' });
    const data = await r.json();
    if (!data.ok) throw new Error(data.error || 'No se pudo cargar');
    if (!data.logs.length) {
      tablaLogs.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Sin registros</td></tr>';
      return;
    }
    tablaLogs.innerHTML = data.logs.map(l => `
      <tr>
        <td>${l.filename || ''}</td>
        <td>${l.total_rows ?? '-'}</td>
        <td>${l.inserted ?? '-'}</td>
        <td>${l.skipped ?? '-'}</td>
        <td>${l.started_at ? new Date(l.started_at).toLocaleString() : '-'}</td>
        <td>${l.finished_at ? new Date(l.finished_at).toLocaleString() : '-'}</td>
      </tr>
    `).join('');
  } catch(err) {
    tablaLogs.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${err.message}</td></tr>`;
  }
}

btnSubir.addEventListener('click', async () => {
  const file = archivo.files[0];
  if (!file) return alert('Seleccione un archivo antes de importar.');

  statusArea.classList.remove('d-none');
  actualizarBarra(0);
  iniciarCronometro();

  const form = new FormData();
  form.append('archivo', file);

  try {
    const resp = await fetch(API_URL, { method: 'POST', body: form });
    const data = await resp.json();
    detenerCronometro();

    if (!data.ok) {
      actualizarBarra(100);
      alert('❌ Error: ' + (data.error || 'No se pudo importar.'));
    } else {
      actualizarBarra(100);
      alert(`✅ Importación completada\n\nTotal: ${data.total}\nInsertados: ${data.insertados}\nSaltados: ${data.saltados}`);
      cargarHistorial();
    }
  } catch (e) {
    detenerCronometro();
    alert('Error de conexión o formato inválido.\n' + e.message);
  }
});

btnCancelar.addEventListener('click', limpiarFormulario);

window.addEventListener('DOMContentLoaded', cargarHistorial);
</script>
</body>
</html>
