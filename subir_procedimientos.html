<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gesti√≥n de Licitaciones ‚Äî Subir procedimientos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root{ --acento:#0B4912; --acento-2:#126a1a; }
    body{ background:#0b0f24; color:#0e1b2a; }
    .hero{ background:linear-gradient(180deg,#0b0f24 0%, #0e132c 100%); color:#eaf2ff; padding:48px 0 56px; }
    .glass{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    .btn-acento{ background:var(--acento); color:#fff; border:none; }
    .btn-acento:hover{ filter:brightness(1.05); color:#fff; }
    .small-muted{ color:#6b7b91; font-size:.9rem; }
    code{ background:#f3f6fa; padding:.15rem .35rem; border-radius:.35rem; }
    .progress{ height:8px; }
    pre.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; white-space:pre-wrap; }
  </style>
</head>
<body>

<header class="hero">
  <div class="container d-flex align-items-center gap-3">
    <span class="d-inline-flex align-items-center justify-content-center bg-success rounded-3"
          style="width:48px;height:48px;box-shadow:0 8px 24px rgba(16,185,129,.25)">
      <i class="bi bi-upload text-white fs-4"></i>
    </span>
    <div>
      <h1 class="h4 m-0">Importar ‚ÄúProcedimientos Adjudicados‚Äù</h1>
      <div class="text-white-50 small">Sube un archivo .csv, .tsv o .txt con encabezados</div>
    </div>
  </div>
</header>

<main class="container" style="margin-top:-36px;margin-bottom:64px;">
  <div class="glass p-3 p-lg-4">
    <form id="frm" class="vstack gap-3" enctype="multipart/form-data">
      <div class="row g-3">

    <div class="col-12 col-lg-8">
       <label class="form-label">
         Bienvenido al importador de procedimientos de adjudicaci√≥n del Departamento de Licitaciones
       </label>
         <input class="form-control" type="file" name="archivo" id="archivo" accept=".csv,.txt" required />
        <div class="form-text small-muted">
          Por favor, cargue un archivo con extensi√≥n <code>.csv</code> o <code>.txt</code>
          El limite por archivo es de 3500 filas.
       </div>
    </div>

        <div class="col-12 col-lg-4">
          <label class="form-label">Opciones</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="tieneHeader" checked>
            <label class="form-check-label" for="tieneHeader">Primera fila contiene encabezados</label>
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-acento" id="btnEnviar" type="submit">
          <i class="bi bi-cloud-arrow-up me-1"></i> Subir e importar
        </button>
        <button class="btn btn-outline-danger" type="button" id="btnCancelar" disabled>
          <i class="bi bi-x-circle me-1"></i> Cancelar
        </button>
        <button class="btn btn-outline-secondary" type="reset" id="btnReset">
          <i class="bi bi-eraser me-1"></i> Limpiar
        </button>
      </div>

      <div class="row g-3 align-items-center">
        <div class="col-auto small text-muted">Tiempo transcurrido: <span id="timer">00:00</span></div>
      </div>

      <div class="d-none" id="pgwrap">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <small class="text-muted">Progreso</small>
          <small class="text-muted" id="pct">0%</small>
        </div>
        <div class="progress"><div class="progress-bar bg-success" id="bar" style="width:0%"></div></div>
      </div>

      <div id="msg" class="small"></div>
      <div id="res" class="mt-2 small"></div>
      <pre id="raw" class="mono small d-none p-2 bg-light border rounded"></pre>
    </form>
  </div>

  <!-- Historial debajo -->
  <section class="glass p-3 p-lg-4 mt-3">
    <div class="d-flex align-items-center justify-content-between">
      <h2 class="h6 m-0">Historial de importaciones</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" id="btnRefrescar">
          <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
        </button>
        <button class="btn btn-sm btn-outline-danger" id="btnAnularUltimo">
          <i class="bi bi-arrow-counterclockwise me-1"></i>Anular √∫ltimo
        </button>
      </div>
    </div>
    <div class="table-responsive mt-3">
      <table class="table table-sm align-middle">
        <thead><tr>
          <th>Fecha</th><th>Archivo</th><th>Modo</th><th>Insertados</th><th>Saltados</th><th></th>
        </tr></thead>
        <tbody id="histRows"><tr><td colspan="6" class="text-muted">Cargando‚Ä¶</td></tr></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  const API_URL = 'api/procedimientos_importar.php';
  const $ = (s,d=document)=>d.querySelector(s);

  let controller=null, fakeTimer=null, t0=0, tick=null;

  function escapeHTML(s){ return (s ?? '').toString().replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function setProgress(p){ $('#pgwrap').classList.remove('d-none'); $('#bar').style.width=p+'%'; $('#pct').textContent=p+'%'; }
  function startFakeProgress(){ let p=5; setProgress(p); fakeTimer=setInterval(()=>{ p=Math.min(p+Math.random()*4+1,85); setProgress(Math.round(p)); if(p>=85){clearInterval(fakeTimer);fakeTimer=null;} },400); }
  function stopFakeProgress(){ if(fakeTimer){ clearInterval(fakeTimer); fakeTimer=null; } }
  function fmt(ms){ const s=Math.floor(ms/1000), m=String(Math.floor(s/60)).padStart(2,'0'), ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }
  function startTimer(){ t0=performance.now(); $('#timer').textContent='00:00'; tick=setInterval(()=>{ $('#timer').textContent=fmt(performance.now()-t0); },500); }
  function stopTimer(){ if(tick){ clearInterval(tick); tick=null; } }

  async function fetchHistorial(){
    const body=$('#histRows'); body.innerHTML='<tr><td colspan="6" class="text-muted">Cargando‚Ä¶</td></tr>';
    try{
      const r = await fetch(API_URL+'?historial=1'); const j = await r.json();
      if(!j.ok){ body.innerHTML='<tr><td colspan="6">No se pudo cargar</td></tr>'; return; }
      if(!j.historial.length){ body.innerHTML='<tr><td colspan="6" class="text-muted">Sin registros</td></tr>'; return; }
      body.innerHTML='';
      j.historial.forEach(h=>{
        const d=new Date(h.started_at);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${d.toLocaleString()}</td>
          <td>${escapeHTML(h.filename||'-')}</td>
          <td>${escapeHTML(h.mode||'-')}</td>
          <td>${h.inserted}</td>
          <td>${h.skipped}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger" data-anular="${h.import_id}">Anular</button>
          </td>`;
        body.appendChild(tr);
      });
    }catch{ body.innerHTML='<tr><td colspan="6">Error de red</td></tr>'; }
  }

  async function anular(import_id=null){
    const fd=new FormData(); fd.append('accion','anular'); if(import_id) fd.append('import_id',import_id);
    const r = await fetch(API_URL,{method:'POST',body:fd}); const j = await r.json().catch(()=>({ok:false,error:'Respuesta no JSON'}));
    if(!j.ok){ alert('No se pudo anular: '+(j.error||'desconocido')); return; }
    $('#msg').innerHTML = `üóëÔ∏è Importaci√≥n anulada: <code>${j.anulado}</code> ‚Äî filas eliminadas: <strong>${j.eliminadas}</strong>`;
    fetchHistorial();
  }

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-anular]'); if(btn){ e.preventDefault(); anular(btn.getAttribute('data-anular')); }
  });
  $('#btnAnularUltimo').addEventListener('click', ()=>anular());
  $('#btnRefrescar').addEventListener('click', fetchHistorial);

  $('#frm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const file = $('#archivo').files[0];
    if(!file){ $('#msg').textContent='Seleccione un archivo.'; return; }

    const fd = new FormData();
    fd.append('archivo', file);
    fd.append('tiene_header', $('#tieneHeader').checked ? '1' : '0');

    controller = new AbortController();
    $('#btnEnviar').disabled=true; $('#btnCancelar').disabled=false;
    $('#msg').textContent='Subiendo‚Ä¶'; $('#res').textContent=''; $('#raw').classList.add('d-none');
    startFakeProgress(); startTimer();

    try{
      const r = await fetch(API_URL,{method:'POST',body:fd,signal:controller.signal});
      stopFakeProgress(); setProgress(100); stopTimer();

      const raw = await r.text(); let j; try{ j=JSON.parse(raw); }catch{ j={ok:false,error:raw}; }
      if(!r.ok || !j.ok){
        $('#msg').innerHTML='‚ö† Error: '+escapeHTML(j.error||'desconocido');
        if(j.debug){ $('#raw').classList.remove('d-none'); $('#raw').innerHTML=escapeHTML(j.debug); }
        return;
      }
      $('#msg').innerHTML = `‚úÖ Importaci√≥n completada (modo: <strong>${j.modo}</strong>) ‚Äî import_id: <code>${j.import_id}</code>`;
      const errs = Array.isArray(j.errores) ? j.errores.length : (j.errores ?? 0);
      $('#res').innerHTML =
        `<div class="alert alert-success mt-2">
           Insertados: <strong>${j.insertados}</strong> ‚Äî Saltados: <strong>${j.saltados}</strong> ‚Äî Errores: <strong>${errs}</strong>
         </div>` +
        (Array.isArray(j.errores) && j.errores.length
          ? `<details class="mt-2"><summary>Errores (${j.errores.length})</summary><pre class="mono">${escapeHTML(j.errores.slice(0,50).join('\n'))}${j.errores.length>50?'\n‚Ä¶':''}</pre></details>`:'');
      fetchHistorial();
    }catch(err){
      stopFakeProgress(); stopTimer();
      $('#msg').textContent = (err.name==='AbortError') ? '‚õî Importaci√≥n cancelada.' : ('‚ö† '+(err.message||String(err)));
    }finally{
      $('#btnEnviar').disabled=false; $('#btnCancelar').disabled=true; controller=null;
    }
  });

  $('#btnCancelar').addEventListener('click', ()=>{ if(controller){ controller.abort(); } });
  $('#btnReset').addEventListener('click', ()=>{ $('#msg').textContent=''; $('#res').textContent=''; $('#raw').textContent=''; $('#raw').classList.add('d-none'); stopFakeProgress(); stopTimer(); $('#bar').style.width='0%'; $('#pct').textContent='0%'; $('#pgwrap').classList.add('d-none'); $('#timer').textContent='00:00'; });

  fetchHistorial();
</script>
</body>
</html>
