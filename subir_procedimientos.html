<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Licitaciones — Subir procedimientos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root{ --acento:#0B4912; --acento-2:#126a1a; }
    body{ background:#0b0f24; color:#0e1b2a; }
    .hero{ background:linear-gradient(180deg,#0b0f24 0%, #0e132c 100%); color:#eaf2ff; padding:48px 0 56px; }
    .glass{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    .btn-acento{ background:var(--acento); color:#fff; border:none; }
    .btn-acento:hover{ filter:brightness(1.05); color:#fff; }
    .small-muted{ color:#6b7b91; font-size:.9rem; }
    code{ background:#f3f6fa; padding:.15rem .35rem; border-radius:.35rem; }
    .progress{ height:8px; }
    pre.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; white-space:pre-wrap; }
  </style>
</head>
<body>

<header class="hero">
  <div class="container d-flex align-items-center gap-3">
    <span class="d-inline-flex align-items-center justify-content-center bg-success rounded-3"
          style="width:48px;height:48px;box-shadow:0 8px 24px rgba(16,185,129,.25)">
      <i class="bi bi-upload text-white fs-4"></i>
    </span>
    <div>
      <h1 class="h4 m-0">Importar “Procedimientos Adjudicados”</h1>
      <div class="text-white-50 small">Sube un archivo .csv o .txt con encabezados</div>
    </div>
  </div>
</header>

<main class="container" style="margin-top:-36px;margin-bottom:64px;">
  <div class="glass p-3 p-lg-4">
    <form id="frm" class="vstack gap-3" enctype="multipart/form-data">
      <div class="row g-3">
        <div class="col-12 col-lg-8">
          <label class="form-label">Archivo de procedimientos</label>
          <input class="form-control" type="file" name="archivo" id="archivo" accept=".csv,.txt" required />
          <div class="form-text small-muted">Formato UTF-8 delimitado por punto y coma (“;”).</div>
        </div>
        <div class="col-12 col-lg-4 d-flex align-items-end">
          <button class="btn btn-acento w-100" id="btnEnviar" type="submit">
            <i class="bi bi-cloud-arrow-up me-1"></i> Subir e importar
          </button>
        </div>
      </div>

      <div class="mt-3" id="pgwrap" style="display:none;">
        <small class="text-muted d-block mb-1">Progreso</small>
        <div class="progress"><div class="progress-bar bg-success" id="bar" style="width:0%"></div></div>
        <div class="text-muted small mt-1">Tiempo: <span id="timer">00:00</span></div>
      </div>

      <div id="msg" class="small mt-3"></div>
    </form>
  </div>

  <section class="glass p-3 p-lg-4 mt-3">
    <h2 class="h6 m-0 mb-2">Historial de importaciones</h2>
    <div class="table-responsive mt-2">
      <table class="table table-sm align-middle">
        <thead><tr>
          <th>Fecha</th><th>Archivo</th><th>Insertados</th><th>Saltados</th><th>Total</th>
        </tr></thead>
        <tbody id="histRows"><tr><td colspan="5" class="text-muted">Cargando…</td></tr></tbody>
      </table>
    </div>
  </section>
</main>

<script>
const API_URL = 'api/procedimientos_importar.php';
const $ = (s,d=document)=>d.querySelector(s);

function setProgress(p){ $('#pgwrap').style.display='block'; $('#bar').style.width=p+'%'; }
function fmt(ms){ const s=Math.floor(ms/1000), m=String(Math.floor(s/60)).padStart(2,'0'), ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }

async function fetchHist(){
  const body=$('#histRows');
  try{
    const r=await fetch(API_URL+'?accion=logs');
    const j=await r.json();
    if(!j.ok) throw new Error(j.error||'No se pudo cargar');
    if(!j.logs.length){ body.innerHTML='<tr><td colspan="5" class="text-muted">Sin registros</td></tr>'; return; }
    body.innerHTML=j.logs.map(l=>`
      <tr>
        <td>${new Date(l.started_at).toLocaleString()}</td>
        <td>${l.filename}</td>
        <td>${l.inserted}</td>
        <td>${l.skipped}</td>
        <td>${l.total_rows}</td>
      </tr>`).join('');
  }catch(e){ body.innerHTML='<tr><td colspan="5" class="text-danger">'+e.message+'</td></tr>'; }
}

$('#frm').addEventListener('submit', async e=>{
  e.preventDefault();
  const f=$('#archivo').files[0];
  if(!f){ $('#msg').textContent='Seleccione un archivo.'; return; }
  $('#msg').textContent='Subiendo…'; setProgress(10);
  const fd=new FormData(); fd.append('archivo',f);
  const start=performance.now();
  try{
    const r=await fetch(API_URL,{method:'POST',body:fd});
    const j=await r.json();
    setProgress(100);
    $('#msg').innerHTML=j.ok?`✅ Insertados: <b>${j.insertados}</b> / Saltados: <b>${j.saltados}</b> / Total: ${j.total}`:`⚠ Error: ${j.error}`;
  }catch(err){
    $('#msg').innerHTML='⚠ '+err.message;
  }
  $('#timer').textContent=fmt(performance.now()-start);
  fetchHist();
});

window.addEventListener('DOMContentLoaded', fetchHist);
</script>
</body>
</html>
