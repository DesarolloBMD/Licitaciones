<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Importar Procedimientos Adjudicados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --acento:#0B4912;
      --acento-2:#126a1a;
      --bg-hero: radial-gradient(1200px 600px at 10% -10%, #d9f99d55, transparent 40%),
                 radial-gradient(1000px 600px at 90% -20%, #34d39933, transparent 45%),
                 linear-gradient(180deg,#0b0f24 0%, #0b0f24 40%, #0e132c 100%);
    }
    body{ background:#0b0f24; color:#0e1b2a; font-family:'Inter',sans-serif; }
    .hero{ background:var(--bg-hero); color:#eaf2ff; padding:48px 0 72px; text-align:center; }
    .hero h1{ letter-spacing:.3px; font-weight:600; }
    .glass{ background:rgba(255,255,255,.9); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.6); box-shadow:0 10px 30px rgba(0,0,0,.12); border-radius:18px; }
    .btn-acento{ background:linear-gradient(90deg,var(--acento),var(--acento-2)); color:#fff; border:none; }
    .btn-acento:hover{ filter:brightness(1.05); color:#fff; }
    .progress{ height:8px; border-radius:8px; overflow:hidden; }
    pre{ white-space:pre-wrap; font-family:ui-monospace, monospace; background:#f8fafc; }
    .table-hover tbody tr:hover{ background:#f6fff6; }
    .badge-soft{ background:#e8ffe8; color:#0b4912; border:1px solid #bde5bd; }
  </style>
</head>
<body>

  <section class="hero">
    <div class="container">
      <h1><i class="bi bi-cloud-upload me-2"></i>Importar Procedimientos Adjudicados</h1>
      <p class="lead text-secondary">Carga, validación y control de importaciones CSV/TXT</p>
    </div>
  </section>

  <main class="container my-5" style="max-width:950px;">
    <div class="glass p-4 p-lg-5">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="h5 text-success mb-0"><i class="bi bi-folder-plus me-2"></i>Gestor de carga de archivos</h2>
        <span class="badge-soft px-3 py-2 rounded-pill small">Versión CSV/TXT</span>
      </div>

      <form id="frm" enctype="multipart/form-data" class="d-flex flex-column gap-3">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Mes de Descarga</label>
            <select name="mes_descarga" class="form-select" required>
              <option value="">Seleccione...</option>
              <option>Enero</option><option>Febrero</option><option>Marzo</option>
              <option>Abril</option><option>Mayo</option><option>Junio</option>
              <option>Julio</option><option>Agosto</option><option>Septiembre</option>
              <option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Año de Descarga</label>
            <select name="anio_descarga" class="form-select" required>
              <option value="">Seleccione...</option>
              <option>2023</option><option>2024</option><option>2025</option>
            </select>
          </div>
        </div>

        <div>
          <label class="form-label">Archivo de procedimientos (.csv o .txt)</label>
          <input type="file" name="archivo" id="archivo" class="form-control" accept=".csv,.txt" required>
          <div class="form-text text-muted">
            Asegúrese de que los encabezados coincidan con el formato esperado:<br>
            <code>CEDULA;INSTITUCION;ANO;NUMERO_PROCEDIMIENTO;...</code>
          </div>
        </div>

        <div class="d-flex gap-2 align-items-center mt-2">
          <button id="btnSubir" type="submit" class="btn btn-acento px-3">
            <i class="bi bi-upload me-1"></i> Subir e importar
          </button>
          <button id="btnCancelar" type="button" class="btn btn-outline-danger" disabled>
            <i class="bi bi-x-circle me-1"></i> Cancelar
          </button>
          <button id="btnLimpiar" type="button" class="btn btn-outline-secondary">
            <i class="bi bi-trash me-1"></i> Limpiar
          </button>
          <span id="cronometro" class="ms-auto small text-muted"></span>
        </div>

        <div id="barWrap" class="progress mt-3" style="display:none;">
          <div id="bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%"></div>
        </div>

        <pre id="log" class="border rounded p-3 small"></pre>
      </form>

      <hr class="my-4">

      <h5 class="mb-3 text-success"><i class="bi bi-clock-history me-2"></i>Historial de importaciones</h5>
      <div class="table-responsive">
        <table id="tblHistorial" class="table table-sm table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Archivo</th><th>Mes</th><th>Año</th><th>Insertados</th><th>Saltados</th><th>Total</th><th>Fecha</th><th></th>
            </tr>
          </thead>
          <tbody><tr><td colspan="8" class="text-center text-muted">Cargando...</td></tr></tbody>
        </table>
      </div>
    </div>
  </main>

<script>
const ENDPOINT = "api/subir_procedimientos.php";
const frm = document.getElementById('frm');
const barWrap = document.getElementById('barWrap');
const bar = document.getElementById('bar');
const log = document.getElementById('log');
const tbl = document.querySelector('#tblHistorial tbody');
const btnSubir = document.getElementById('btnSubir');
const btnCancelar = document.getElementById('btnCancelar');
const btnLimpiar = document.getElementById('btnLimpiar');
const cronometro = document.getElementById('cronometro');
let controller = null, timer = null, segundos = 0;

frm.addEventListener('submit', async e => {
  e.preventDefault();
  const fd = new FormData(frm);
  controller = new AbortController();
  btnSubir.disabled = true;
  btnCancelar.disabled = false;
  barWrap.style.display = 'block';
  bar.style.width = '5%';
  log.textContent = '⏳ Subiendo...';
  segundos = 0;
  cronometro.textContent = "0s";
  timer = setInterval(()=>{ segundos++; cronometro.textContent = segundos+'s'; },1000);

  try {
    const res = await fetch(ENDPOINT, { method:'POST', body:fd, signal:controller.signal });
    const txt = await res.text();
    let data;
    try { data = JSON.parse(txt); } catch { throw new Error('⚠ Respuesta no válida del servidor:\n' + txt.slice(0,300)); }

    if (!data.ok) throw new Error(data.error || 'Error desconocido en la importación');
    bar.style.width = '100%';
    const errores = (data.errores || []).slice(0,10).map(e => '- '+e).join('\n');
    log.textContent = `✅ Importación completada\nInsertados: ${data.insertados}\nSaltados: ${data.saltados}\nTotal: ${data.total}\n${errores ? '\nErrores:\n'+errores : ''}`;
    cargarHistorial();
  } catch(err){
    log.textContent = err.name==='AbortError' ? '⛔ Importación cancelada.' : '⚠ '+err.message;
  } finally {
    btnSubir.disabled = false;
    btnCancelar.disabled = true;
    clearInterval(timer);
    controller = null;
    setTimeout(()=>{ barWrap.style.display='none'; bar.style.width='0%'; }, 800);
  }
});

btnCancelar.addEventListener('click',()=>{ if(controller) controller.abort(); });
btnLimpiar.addEventListener('click',()=>{ frm.reset(); log.textContent=''; bar.style.width='0%'; barWrap.style.display='none'; cronometro.textContent=''; });

async function cargarHistorial(){
  try{
    const r = await fetch(ENDPOINT+'?action=historial');
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'Error al cargar historial');
    if(!Array.isArray(data.rows) || !data.rows.length){
      tbl.innerHTML='<tr><td colspan="8" class="text-center text-muted">Sin registros</td></tr>';
      return;
    }
    tbl.innerHTML = data.rows.map(x=>`
      <tr>
        <td>${x.filename || '(sin nombre)'}</td>
        <td>${x.mes_descarga || '-'}</td>
        <td>${x.anio_descarga || '-'}</td>
        <td>${x.inserted ?? 0}</td>
        <td>${x.skipped ?? 0}</td>
        <td>${x.total_rows ?? (x.inserted + x.skipped ?? 0)}</td>
        <td>${x.finished_at ? new Date(x.finished_at).toLocaleString() : '-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-danger" onclick="anularImportacion('${x.import_id}')">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>`).join('');
  }catch(err){
    tbl.innerHTML=`<tr><td colspan="8" class="text-danger text-center">Error al cargar historial.<br>${err.message}</td></tr>`;
  }
}

async function anularImportacion(id){
  if(!confirm('¿Seguro desea anular esta importación?')) return;
  try{
    const r = await fetch('api/anular_importacion_procedimientos.php?id='+id);
    const d = await r.json();
    if(!d.ok) throw new Error(d.error || 'Error al anular');
    alert('Importación anulada correctamente');
    cargarHistorial();
  }catch(e){ alert('Error: '+e.message); }
}

cargarHistorial();
</script>

</body>
</html>
