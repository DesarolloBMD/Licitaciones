<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Importar Procedimientos Adjudicados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background:#f6f8fa; }
    .card { border-radius:16px; }
    .btn-acento { background:#0B4912; color:#fff; border:none; }
    .btn-acento:hover { filter:brightness(1.1); color:#fff; }
    .mono { font-family:ui-monospace,monospace; }
    .progress { height:8px; border-radius:10px; overflow:hidden; }
  </style>
</head>
<body class="p-3 p-lg-5">

  <div class="container" style="max-width:950px;">
    <div class="card shadow-sm">
      <div class="card-body p-4">

        <div class="d-flex align-items-center justify-content-between mb-3">
          <h2 class="h5 m-0 text-success">
            <i class="bi bi-cloud-upload me-2"></i>Importar “Procedimientos Adjudicados”
          </h2>
          <span class="badge text-bg-light border">Gestor de carga CSV/TXT</span>
        </div>

        <!-- Formulario de importación -->
        <form id="frm" enctype="multipart/form-data" class="d-flex flex-column gap-3">
          <div>
            <label class="form-label">Archivo de procedimientos (.csv o .txt)</label>
            <input type="file" name="archivo" id="archivo" class="form-control" accept=".csv,.txt" required>
            <div class="form-text">
              Asegúrese de incluir los encabezados correctos. Fechas en formato largo (<em>jueves, 6 de marzo de 2025</em>) se convertirán automáticamente.
            </div>
          </div>

          <div class="d-flex gap-2">
            <button id="btnSubir" type="submit" class="btn btn-acento">
              <i class="bi bi-upload me-1"></i> Subir e importar
            </button>
            <button id="btnCancelar" type="button" class="btn btn-outline-danger" disabled>
              <i class="bi bi-x-circle me-1"></i> Cancelar
            </button>
            <button id="btnLimpiar" type="button" class="btn btn-outline-secondary">
              <i class="bi bi-trash me-1"></i> Limpiar
            </button>
          </div>

          <div id="barWrap" class="progress mt-2" style="display:none;">
            <div id="bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%"></div>
          </div>

          <pre id="log" class="mono small p-2 bg-light border rounded" style="white-space:pre-wrap;max-height:320px;overflow:auto;"></pre>
        </form>

        <hr class="my-4">

        <!-- Historial de importaciones -->
        <h5 class="mb-3 text-success"><i class="bi bi-clock-history me-2"></i>Historial de importaciones</h5>
        <div class="table-responsive">
          <table id="tblHistorial" class="table table-sm table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Archivo</th>
                <th>Insertados</th>
                <th>Saltados</th>
                <th>Total</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="5" class="text-center text-muted">Cargando...</td></tr></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <script>
  const ENDPOINT = "api/subir_procedimientos.php"; // ✅ ruta corregida
  const frm = document.getElementById('frm');
  const btnSubir = document.getElementById('btnSubir');
  const btnCancelar = document.getElementById('btnCancelar');
  const btnLimpiar = document.getElementById('btnLimpiar');
  const barWrap = document.getElementById('barWrap');
  const bar = document.getElementById('bar');
  const log = document.getElementById('log');
  const tbl = document.querySelector('#tblHistorial tbody');
  let controller = null;

  // --- Subir archivo ---
  frm.addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(frm);
    controller = new AbortController();
    btnSubir.disabled = true;
    btnCancelar.disabled = false;
    barWrap.style.display = 'block';
    bar.style.width = '5%';
    log.textContent = 'Subiendo...';

    try {
      const res = await fetch(ENDPOINT, { method: 'POST', body: fd, signal: controller.signal });
      const txt = await res.text();
      let data;
      try { data = JSON.parse(txt); } 
      catch { throw new Error('⚠ Respuesta no válida del servidor:\n' + txt.slice(0,300)); }

      if (!data.ok) throw new Error(data.error || 'Error desconocido en la importación');

      bar.style.width = '100%';
      const errores = (data.errores || []).slice(0,10).map(e => '- ' + e).join('\n');
      log.textContent = `✅ Importación completada
Insertados: ${data.insertados}
Saltados: ${data.saltados}
Total: ${data.total}
${errores ? '\nErrores (primeros 10):\n' + errores : ''}`;
      cargarHistorial();
    } catch (err) {
      log.textContent = err.name === 'AbortError' ? '⛔ Importación cancelada.' : '⚠ Error: ' + err.message;
    } finally {
      btnSubir.disabled = false;
      btnCancelar.disabled = true;
      controller = null;
      setTimeout(() => { barWrap.style.display = 'none'; bar.style.width = '0%'; }, 800);
    }
  });

  // --- Cancelar subida ---
  btnCancelar.addEventListener('click', () => { if (controller) controller.abort(); });

  // --- Limpiar pantalla ---
  btnLimpiar.addEventListener('click', () => {
    frm.reset();
    log.textContent = '';
    bar.style.width = '0%';
    barWrap.style.display = 'none';
  });

  // --- Cargar historial ---
  async function cargarHistorial() {
    try {
      const r = await fetch('api/procedimientos_import_log.php');
      const data = await r.json();
      if (!data.ok) throw new Error(data.error || 'No se pudo cargar el historial');
      if (!Array.isArray(data.rows) || data.rows.length === 0) {
        tbl.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Sin registros</td></tr>';
        return;
      }
      tbl.innerHTML = data.rows.map(x => `
        <tr>
          <td>${x.archivo || '(sin nombre)'}</td>
          <td>${x.insertados ?? 0}</td>
          <td>${x.saltados ?? 0}</td>
          <td>${x.total_filas ?? (x.insertados + x.saltados ?? 0)}</td>
          <td>${x.fin ? new Date(x.fin).toLocaleString() : '-'}</td>
        </tr>`).join('');
    } catch (err) {
      tbl.innerHTML = `<tr><td colspan="5" class="text-danger text-center">No se pudo cargar el historial.<br>${err.message}</td></tr>`;
    }
  }

  cargarHistorial();
  </script>

</body>
</html>
