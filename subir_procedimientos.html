<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Importar Procedimientos Adjudicados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --bg: #f7f8fb;
      --brand: #0B4912;
      --muted: #6b7b91;
    }
    body { background: var(--bg); }
    .card { border-radius: 16px; }
    .btn-brand { background: var(--brand); color: #fff; border: none; }
    .btn-brand:hover { filter: brightness(1.1); color: #fff; }
    pre { font-family: ui-monospace, monospace; font-size: .9rem; }
    .tbl-mini th, .tbl-mini td { vertical-align: middle; }
    #log { white-space: pre-wrap; max-height: 200px; overflow: auto; }
  </style>
</head>
<body class="p-3 p-lg-5">

<div class="container" style="max-width:960px">

  <!-- Card de importación -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h4 class="mb-3"><i class="bi bi-cloud-upload text-success me-2"></i>Importar “Procedimientos Adjudicados”</h4>
      <p class="text-muted small">Cargue un archivo <code>.csv</code> o <code>.txt</code> con los encabezados del sistema.  
        Las fechas deben venir en formato <code>dd/mm/yyyy</code> o <code>yyyy-mm-dd</code>.</p>

      <form id="frm" enctype="multipart/form-data" class="d-flex flex-column gap-3">
        <div>
          <label class="form-label">Archivo</label>
          <input class="form-control" type="file" name="archivo" accept=".csv,.txt" required>
        </div>
        <div class="d-flex gap-2">
          <button id="btnSubir" class="btn btn-brand"><i class="bi bi-upload"></i> Subir e importar</button>
          <button id="btnCancelar" type="button" class="btn btn-outline-danger" disabled><i class="bi bi-x-circle"></i> Cancelar</button>
          <button id="btnLimpiar" type="reset" class="btn btn-outline-secondary"><i class="bi bi-eraser"></i> Limpiar</button>
        </div>

        <div class="progress" style="height:8px;display:none" id="barWrap">
          <div class="progress-bar" id="bar" role="progressbar" style="width:0%"></div>
        </div>

        <pre id="log" class="p-2 bg-light border rounded"></pre>
      </form>
    </div>
  </div>

  <!-- Card de historial -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="mb-3"><i class="bi bi-clock-history me-2 text-secondary"></i>Historial de importaciones</h5>
      <div class="table-responsive">
        <table class="table table-sm align-middle tbl-mini" id="tblLogs">
          <thead>
            <tr>
              <th>Archivo</th>
              <th>Insertados</th>
              <th>Saltados</th>
              <th>Total</th>
              <th>Fecha</th>
              <th>Duración</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7" class="text-center text-muted">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
const API = 'subir_procedimientos.php';
const frm = document.getElementById('frm'),
      btnSubir = document.getElementById('btnSubir'),
      btnCancelar = document.getElementById('btnCancelar'),
      btnLimpiar = document.getElementById('btnLimpiar'),
      bar = document.getElementById('bar'),
      barWrap = document.getElementById('barWrap'),
      log = document.getElementById('log'),
      tbl = document.querySelector('#tblLogs tbody');
let controller = null;

frm.addEventListener('submit', async e => {
  e.preventDefault();
  const fd = new FormData(frm);
  controller = new AbortController();
  btnSubir.disabled = true; btnCancelar.disabled = false;
  barWrap.style.display = 'block'; bar.style.width = '5%';
  log.textContent = 'Subiendo...';
  const startTime = Date.now();
  try {
    const r = await fetch(API, { method: 'POST', body: fd, signal: controller.signal });
    bar.style.width = '70%';
    const data = await r.json();
    if (!data.ok) throw new Error(data.error || 'Error en importación');
    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
    bar.style.width = '100%';
    log.textContent = `✅ Importación completada
Insertados: ${data.insertados}
Saltados: ${data.saltados}
Total: ${data.total}
⏱ Duración: ${elapsed}s`;
    cargarLogs();
  } catch (err) {
    log.textContent = '⚠ ' + (err.name === 'AbortError' ? 'Importación cancelada' : err.message);
  } finally {
    btnSubir.disabled = false; btnCancelar.disabled = true; controller = null;
    setTimeout(() => { barWrap.style.display = 'none'; bar.style.width = '0%'; }, 600);
  }
});

btnCancelar.onclick = () => { if (controller) controller.abort(); };
btnLimpiar.onclick = () => { log.textContent = ''; bar.style.width = '0%'; barWrap.style.display = 'none'; };

async function cargarLogs() {
  tbl.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Cargando...</td></tr>';
  const r = await fetch(API + '?accion=logs');
  const data = await r.json();
  if (!data.ok) {
    tbl.innerHTML = '<tr><td colspan="7" class="text-danger text-center">No se pudo cargar</td></tr>';
    return;
  }
  if (!data.logs.length) {
    tbl.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Sin registros</td></tr>';
    return;
  }
  tbl.innerHTML = data.logs.map(l => {
    let dur = '';
    if (l.started_at && l.finished_at) {
      const s = new Date(l.started_at);
      const f = new Date(l.finished_at);
      dur = ((f - s) / 1000).toFixed(1) + 's';
    }
    return `
      <tr>
        <td>${l.filename || '-'}</td>
        <td>${l.inserted || 0}</td>
        <td>${l.skipped || 0}</td>
        <td>${l.total_rows || 0}</td>
        <td>${(l.started_at || '').replace('T', ' ').split('.')[0]}</td>
        <td>${dur}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" onclick="anular('${l.import_id}')">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>`;
  }).join('');
}

async function anular(id) {
  if (!confirm('¿Seguro que deseas eliminar esta importación?')) return;
  const r = await fetch(API + '?accion=anular&id=' + encodeURIComponent(id));
  const data = await r.json();
  if (data.ok) {
    alert('Importación eliminada correctamente.');
    cargarLogs();
  } else {
    alert('Error: ' + data.error);
  }
}

cargarLogs();
</script>
</body>
</html>
