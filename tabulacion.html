<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Licitaciones — Tabulación</title>

  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root{
      --acento:#0B4912;
      --acento-2:#126a1a;
      --bg-hero: radial-gradient(1200px 600px at 10% -10%, #d9f99d55, transparent 40%),
                 radial-gradient(1000px 600px at 90% -20%, #34d39933, transparent 45%),
                 linear-gradient(180deg,#0b0f24 0%, #0b0f24 40%, #0e132c 100%);
    }
    body{ background:#0b0f24; color:#0e1b2a; }
    .hero{ background:var(--bg-hero); color:#eaf2ff; padding:48px 0 72px; position:relative; overflow:hidden; }
    .hero h1{ letter-spacing:.3px }
    .badge-soft{ background:#e8ffe8; color:#0b4912; border:1px solid #bde5bd; }
    .glass{ background:rgba(255,255,255,.92); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.6); box-shadow:0 10px 30px rgba(0,0,0,.12); border-radius:18px; }

    .section-title{ color:#11223b; }
    .divider{ height:1px; background:linear-gradient(90deg,transparent,#e7edf6,transparent); margin:.75rem 0 1.25rem; }
    .btn-acento{ background:var(--acento); color:#fff; border:none; }
    .btn-acento:hover{ filter:brightness(1.05); color:#fff; }

    .table thead th{ white-space:nowrap; }
    .truncate{ max-width:340px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  </style>
</head>
<body>

  <!-- HERO -->
  <header class="hero">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          <span class="d-inline-flex align-items-center justify-content-center bg-success rounded-3" style="width:48px;height:48px;box-shadow:0 8px 24px rgba(16,185,129,.25)">
            <i class="bi bi-table text-white fs-4"></i>
          </span>
          <div>
            <h1 class="h3 m-0">Tabulación de licitaciones</h1>
            <div class="text-white-50 small">Busca, visualiza, edita y borra registros</div>
          </div>
        </div>
        <span class="badge badge-soft rounded-pill px-3 py-2">
          <i class="bi bi-shield-lock me-2"></i>Sesión segura
        </span>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container" style="margin-top:-42px; margin-bottom:64px;">
    <div class="glass p-3 p-lg-4">
      <!-- Filtros -->
      <div class="d-flex align-items-end gap-2 flex-wrap mb-3">
        <div class="flex-grow-1">
          <label class="form-label">Buscar (Empresa o Nº licitación)</label>
          <input id="q" class="form-control" placeholder="Ej: ACME o 2025-XX-0001" />
        </div>
        <div>
          <label class="form-label">Año</label>
          <input id="anio" type="number" class="form-control" min="2000" max="2100" />
        </div>
        <div>
          <label class="form-label">Mes</label>
          <input id="mes" type="number" class="form-control" min="1" max="12" />
        </div>
        <div class="d-flex gap-2">
          <button id="btnBuscar" class="btn btn-success"><i class="bi bi-search me-1"></i> Buscar</button>
          <button id="btnLimpiar" class="btn btn-outline-secondary"><i class="bi bi-eraser me-1"></i> Limpiar</button>
          <a href="registro.html" class="btn btn-acento"><i class="bi bi-plus-circle me-1"></i> Nueva</a>
        </div>
      </div>

      <!-- Tabla -->
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Nº Licitación</th>
              <th>Empresa</th>
              <th>Estado</th>
              <th>Respuesta</th>
              <th>Tipo</th>
              <th>Creado</th>
              <th>Última observación</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="9" class="text-center text-muted">Cargando…</td></tr>
          </tbody>
        </table>
      </div>

      <div id="msg" class="small text-muted mt-2"></div>
    </div>
  </main>

  <!-- Modal Editar -->
  <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2">
            <i class="bi bi-pencil-square text-success"></i> Editar licitación
          </h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="form-edit">
            <input type="hidden" id="e-id">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label">Estado</label>
                <select id="e-estado" class="form-select">
                  <option>en proceso</option>
                  <option>finalizada</option>
                </select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Respuesta</label>
                <select id="e-respuesta" class="form-select">
                  <option>pendiente</option>
                  <option>perdida</option>
                  <option>ganada</option>
                </select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Tipo</label>
                <select id="e-tipo" class="form-select">
                  <option>cantidad definida</option>
                  <option>demanda</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">Última observación</label>
                <textarea id="e-ultima" class="form-control" rows="4" placeholder="Notas de seguimiento…"></textarea>
                <div class="form-text">Deja vacío para borrar la última observación.</div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <div id="edit-msg" class="me-auto small text-muted"></div>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnGuardar" class="btn btn-acento"><i class="bi bi-check2-circle me-1"></i> Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>

 <!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Base: raíz del servicio (sin /API/)
  const RENDER_API = 'https://licitaciones-5kie.onrender.com/'; 
  const usingGithub = location.hostname.endsWith('github.io') || location.protocol === 'file:';
  const API_BASE = usingGithub ? RENDER_API : '/';

  const API_BUSCAR = API_BASE + 'licitaciones_buscar.php';
  const API_CARGAR = API_BASE + 'licitacion_cargar.php';
  const API_EDITAR = API_BASE + 'licitacion_actualizar.php';
  const API_BORRAR = API_BASE + 'licitacion_borrar.php';
</script>


    const $ = (s, d=document)=>d.querySelector(s);
    function escapeHTML(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function fmtDateTime(v){ return v ? new Date(v).toLocaleString('es-CR') : '—'; }

    async function buscar(){
      const params = new URLSearchParams();
      const q = $('#q').value.trim();
      const anio = $('#anio').value.trim();
      const mes  = $('#mes').value.trim();
      if(q) params.set('q', q);
      if(anio) params.set('anio', anio);
      if(mes)  params.set('mes',  mes);
      const msg = $('#msg'); const tb = $('#tbody');
      msg.textContent = 'Cargando…';
      tb.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Cargando…</td></tr>`;

      try{
        const r = await fetch(API_BUSCAR + '?' + params.toString());
        const ct = (r.headers.get('content-type')||'').toLowerCase();
        if(!ct.includes('application/json')){
          const text = await r.text();
          tb.innerHTML = `<tr><td colspan="9" class="text-danger">Error: la API no devolvió JSON.<pre class="small mt-2 mb-0">${escapeHTML(text)}</pre></td></tr>`;
          msg.textContent = '';
          return;
        }
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.error || 'Error en búsqueda');

        const rows = j.rows || [];
        if(!rows.length){
          tb.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4"><i class="bi bi-inbox me-1"></i> Sin resultados</td></tr>`;
        }else{
          tb.innerHTML = '';
          rows.forEach(row=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row.id}</td>
              <td>${escapeHTML(row.numero_licitacion)}</td>
              <td class="truncate" title="${escapeHTML(row.empresa_solicitante||'')}">${escapeHTML(row.empresa_solicitante||'')}</td>
              <td>${escapeHTML(row.estado)}</td>
              <td>${escapeHTML(row.respuesta)}</td>
              <td>${escapeHTML(row.tipo)}</td>
              <td>${fmtDateTime(row.creado_en)}</td>
              <td class="truncate" title="${escapeHTML(row.ultima_observacion||'')}">${escapeHTML(row.ultima_observacion||'')}</td>
              <td class="text-nowrap">
                <button class="btn btn-sm btn-outline-primary me-1" data-action="edit" data-id="${row.id}"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger" data-action="del" data-id="${row.id}"><i class="bi bi-trash"></i></button>
              </td>
            `;
            tb.appendChild(tr);
          });

          // acciones
          tb.querySelectorAll('button[data-action="edit"]').forEach(btn=>{
            btn.addEventListener('click', ()=> abrirEditar(Number(btn.dataset.id)));
          });
          tb.querySelectorAll('button[data-action="del"]').forEach(btn=>{
            btn.addEventListener('click', ()=> borrarRegistro(Number(btn.dataset.id)));
          });
        }
        msg.textContent = `${rows.length} registro(s)`;
      }catch(err){
        $('#tbody').innerHTML = `<tr><td colspan="9" class="text-danger">⚠ ${escapeHTML(err.message||String(err))}</td></tr>`;
        $('#msg').textContent = '';
      }
    }

    async function abrirEditar(id){
      const msg = $('#edit-msg'); msg.textContent = 'Cargando…';
      try{
        const r = await fetch(API_CARGAR + '?id=' + encodeURIComponent(id));
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.error || 'Error al cargar');
        $('#e-id').value = j.row.id;
        $('#e-estado').value = j.row.estado;
        $('#e-respuesta').value = j.row.respuesta;
        $('#e-tipo').value = j.row.tipo;
        $('#e-ultima').value = j.row.ultima_observacion || '';
        msg.textContent = '';
        new bootstrap.Modal($('#modalEditar')).show();
      }catch(err){
        msg.textContent = '⚠ ' + (err.message || String(err));
        new bootstrap.Modal($('#modalEditar')).show();
      }
    }

    async function guardarEdicion(){
      const id = Number($('#e-id').value);
      const fd = new FormData();
      fd.set('id', id);
      fd.set('estado', $('#e-estado').value);
      fd.set('respuesta', $('#e-respuesta').value);
      fd.set('tipo', $('#e-tipo').value);
      fd.set('ultima_observacion', $('#e-ultima').value.trim());

      const msg = $('#edit-msg');
      msg.textContent = 'Guardando…';
      try{
        const r = await fetch(API_EDITAR, { method:'POST', body: fd });
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.error || 'Error al actualizar');
        msg.textContent = '¡Actualizado!';
        setTimeout(()=>bootstrap.Modal.getInstance($('#modalEditar')).hide(), 300);
        buscar();
      }catch(err){
        msg.textContent = '⚠ ' + (err.message || String(err));
      }
    }

    async function borrarRegistro(id){
      if(!confirm('¿Borrar el registro #' + id + '?')) return;
      const fd = new FormData(); fd.set('id', id);
      const msg = $('#msg'); msg.textContent = 'Borrando…';
      try{
        const r = await fetch(API_BORRAR, { method:'POST', body: fd });
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.error || 'Error al borrar');
        msg.textContent = 'Registro borrado';
        buscar();
      }catch(err){
        msg.textContent = '⚠ ' + (err.message || String(err));
      }
    }

    // Eventos
    $('#btnBuscar').addEventListener('click', (e)=>{ e.preventDefault(); buscar(); });
    $('#btnLimpiar').addEventListener('click', ()=>{
      ['q','anio','mes'].forEach(id=>{ const el = document.getElementById(id); if(el) el.value=''; });
      buscar();
    });
    $('#btnGuardar').addEventListener('click', (e)=>{ e.preventDefault(); guardarEdicion(); });

    // Init
    buscar();
  </script>
</body>
</html>
