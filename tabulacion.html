<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestión de Licitaciones — Tabulación</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{ --acento:#0B4912; --acento-2:#126a1a; }
    body{ background:#f6f7fb; }
    .card-kpi{ border:0; box-shadow:0 10px 25px rgba(0,0,0,.06); border-radius:14px; }
    .card-kpi .title{ color:#50627a; font-size:.85rem; text-transform:uppercase; letter-spacing:.3px; }
    .chip { border:1px solid #e7edf6; padding:.25rem .5rem; border-radius:999px; font-size:.8rem; background:#fff; }
    .table thead th{ white-space:nowrap; }
    .btn-acento{ background:var(--acento); color:#fff; border:none; }
    .btn-acento:hover{ filter:brightness(1.05); color:#fff; }
    .truncate{ max-width:340px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  </style>
</head>
<body>
  <div class="container py-4">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 m-0"><i class="bi bi-table me-1"></i> Tabulación de licitaciones</h1>
      <a href="registro.html" class="btn btn-sm btn-acento"><i class="bi bi-plus-circle me-1"></i> Nueva licitación</a>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-6 col-md-3">
        <div class="card card-kpi p-3">
          <div class="title">Total</div>
          <div class="display-6 fw-bold" id="kpi-total">—</div>
          <div class="d-flex gap-2 mt-1">
            <span class="chip">en proceso: <b id="kpi-enproceso">—</b></span>
            <span class="chip">finalizadas: <b id="kpi-finalizadas">—</b></span>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card card-kpi p-3">
          <div class="title">Pendientes</div>
          <div class="display-6 fw-bold" id="kpi-pendientes">—</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card card-kpi p-3">
          <div class="title">Perdidas</div>
          <div class="display-6 fw-bold" id="kpi-perdidas">—</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card card-kpi p-3">
          <div class="title">Ganadas</div>
          <div class="display-6 fw-bold" id="kpi-ganadas">—</div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <form id="filtros" class="row g-2 align-items-end mb-3">
      <div class="col-12 col-md-3">
        <label class="form-label">Buscar</label>
        <input id="f-q" class="form-control" placeholder="texto / Nº licitación">
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Año</label>
        <input id="f-anio" type="number" class="form-control" min="2000" max="2100">
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Mes</label>
        <input id="f-mes" type="number" class="form-control" min="1" max="12">
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Estado</label>
        <select id="f-estado" class="form-select">
          <option value="">—</option>
          <option>en proceso</option>
          <option>finalizada</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Respuesta</label>
        <select id="f-respuesta" class="form-select">
          <option value="">—</option>
          <option>pendiente</option>
          <option>perdida</option>
          <option>ganada</option>
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label">Tipo</label>
        <select id="f-tipo" class="form-select">
          <option value="">—</option>
          <option>cantidad definida</option>
          <option>demanda</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <button class="btn btn-success w-100"><i class="bi bi-search me-1"></i> Buscar</button>
      </div>
    </form>

    <!-- Tabla -->
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nº Licitación</th>
            <th>Empresa</th>
            <th>Estado</th>
            <th>Respuesta</th>
            <th>Tipo</th>
            <th>Creado</th>
            <th>Última observación</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="d-flex gap-2 align-items-center">
      <button id="prev" class="btn btn-outline-secondary btn-sm">« Anterior</button>
      <span id="info" class="small"></span>
      <button id="next" class="btn btn-outline-secondary btn-sm">Siguiente »</button>
    </div>
  </div>

  <!-- Modal Editar -->
  <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-1"></i> Editar licitación</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="form-edit">
            <input type="hidden" id="e-id">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label">Estado</label>
                <select id="e-estado" class="form-select" required>
                  <option>en proceso</option>
                  <option>finalizada</option>
                </select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Respuesta</label>
                <select id="e-respuesta" class="form-select" required>
                  <option>pendiente</option>
                  <option>perdida</option>
                  <option>ganada</option>
                </select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Tipo</label>
                <select id="e-tipo" class="form-select" required>
                  <option>cantidad definida</option>
                  <option>demanda</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">Última observación</label>
                <textarea id="e-ultima" class="form-control" rows="4" placeholder="Notas de seguimiento…"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <div class="me-auto small text-muted" id="edit-msg"></div>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnGuardar" class="btn btn-acento"><i class="bi bi-check2-circle me-1"></i> Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== Config API =====
    const RENDER_API = 'https://licitaciones-5kie.onrender.com/';
    const usingGithub = location.hostname.endsWith('github.io') || location.protocol === 'file:';
    const API_BASE = usingGithub ? RENDER_API : '';

    const API_LIST   = API_BASE + 'licitaciones_listar.php';
    const API_RESUM  = API_BASE + 'licitaciones_resumen.php';
    const API_UPDATE = API_BASE + 'licitacion_actualizar.php';

    let page = 1, pageSize = 20, total = 0, currentData = [];
    const $ = (s, d=document)=>d.querySelector(s);
    function fmtDateTime(v){ return v ? new Date(v).toLocaleString('es-CR') : '—'; }
    function paramsFromFilters(){
      const p = new URLSearchParams();
      p.set('page', page); p.set('page_size', pageSize);
      const q = $('#f-q').value.trim();
      const anio = $('#f-anio').value.trim();
      const mes  = $('#f-mes').value.trim();
      const estado = $('#f-estado').value;
      const respuesta = $('#f-respuesta').value;
      const tipo = $('#f-tipo').value;
      if(q) p.set('q', q);
      if(anio) p.set('anio', anio);
      if(mes) p.set('mes', mes);
      if(estado) p.set('estado', estado);
      if(respuesta) p.set('respuesta', respuesta);
      if(tipo) p.set('tipo', tipo);
      return p;
    }

    async function cargarResumen(){
      const r = await fetch(API_RESUM + '?' + paramsFromFilters().toString());
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || 'Error resumen');
      $('#kpi-total').textContent = j.total;
      $('#kpi-pendientes').textContent = j.por_respuesta.pendiente;
      $('#kpi-perdidas').textContent   = j.por_respuesta.perdida;
      $('#kpi-ganadas').textContent    = j.por_respuesta.ganada;
      $('#kpi-enproceso').textContent  = j.por_estado.en_proceso;
      $('#kpi-finalizadas').textContent= j.por_estado.finalizada;
    }

    async function cargarTabla(){
      const r = await fetch(API_LIST + '?' + paramsFromFilters().toString());
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || 'Error lista');
      total = j.total; currentData = j.rows;
      const tb = $('#tbody'); tb.innerHTML = '';
      j.rows.forEach(row=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.id}</td>
          <td>${row.numero_licitacion}</td>
          <td class="truncate" title="${row.empresa_solicitante || ''}">${row.empresa_solicitante || ''}</td>
          <td>${row.estado}</td>
          <td>${row.respuesta}</td>
          <td>${row.tipo}</td>
          <td>${fmtDateTime(row.creado_en)}</td>
          <td class="truncate" title="${(row.ultima_observacion||'').replace(/"/g,'&quot;')}">${row.ultima_observacion || ''}</td>
          <td><button class="btn btn-sm btn-outline-primary" data-id="${row.id}"><i class="bi bi-pencil"></i></button></td>
        `;
        tb.appendChild(tr);
      });
      const ini = (page-1)*pageSize + 1;
      const fin = Math.min(page*pageSize, total);
      $('#info').textContent = `${ini}-${fin} de ${total}`;
      $('#prev').disabled = (page<=1);
      $('#next').disabled = (fin>=total);

      tb.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = Number(btn.getAttribute('data-id'));
          const row = currentData.find(r => r.id === id);
          if(!row) return;
          $('#e-id').value = row.id;
          $('#e-estado').value = row.estado;
          $('#e-respuesta').value = row.respuesta;
          $('#e-tipo').value = row.tipo;
          $('#e-ultima').value = row.ultima_observacion || '';
          new bootstrap.Modal($('#modalEditar')).show();
        });
      });
    }

    async function cargarTodo(){ await Promise.all([cargarResumen(), cargarTabla()]); }

    document.getElementById('filtros').addEventListener('submit', (e)=>{ e.preventDefault(); page=1; cargarTodo(); });
    document.getElementById('prev').addEventListener('click', ()=>{ if(page>1){ page--; cargarTodo(); }});
    document.getElementById('next').addEventListener('click', ()=>{ if(page*pageSize<total){ page++; cargarTodo(); }});

    document.getElementById('btnGuardar')?.addEventListener('click', async ()=>{
      const id = Number(document.getElementById('e-id').value);
      const payload = {
        id,
        estado: document.getElementById('e-estado').value,
        respuesta: document.getElementById('e-respuesta').value,
        tipo: document.getElementById('e-tipo').value,
        ultima_observacion: document.getElementById('e-ultima').value.trim()
      };
      document.getElementById('edit-msg').textContent = 'Guardando…';
      try{
        const r = await fetch(API_UPDATE, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.error || 'Error al guardar cambios');
        document.getElementById('edit-msg').textContent = '¡Actualizado!';
        setTimeout(()=>bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide(), 400);
        await cargarTodo();
      }catch(err){
        document.getElementById('edit-msg').textContent = '⚠ ' + err.message;
      }
    });

    cargarTodo();
  </script>
</body>
</html>
