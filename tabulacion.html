<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Licitaciones — Tabulación</title>

  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root{
      --acento:#0B4912;
      --acento-2:#126a1a;
      --bg-hero: radial-gradient(1200px 600px at 10% -10%, #d9f99d55, transparent 40%),
                 radial-gradient(1000px 600px at 90% -20%, #34d39933, transparent 45%),
                 linear-gradient(180deg,#0b0f24 0%, #0b0f24 40%, #0e132c 100%);
    }
    body{ background:#0b0f24; }
    .hero{ background:var(--bg-hero); color:#eaf2ff; padding:40px 0 56px; }
    .glass{ background:#fff; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.12); }
    .btn-acento{ background:var(--acento); color:#fff; border:none; }
    .btn-acento:hover{ filter:brightness(1.05); color:#fff; }
    .table thead th{ position:sticky; top:0; z-index:1; background:#f8fafc; }
    .truncate{ max-width: 420px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .th-small{ min-width: 120px; }
    .th-wide { min-width: 240px; }
  </style>
</head>
<body>

  <!-- HERO -->
  <header class="hero">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          <span class="d-inline-flex align-items-center justify-content-center bg-success rounded-3" style="width:48px;height:48px;box-shadow:0 8px 24px rgba(16,185,129,.25)">
            <i class="bi bi-table text-white fs-4"></i>
          </span>
          <div>
            <h1 class="h4 m-0">Tabulación de licitaciones</h1>
            <div class="text-white-50 small">Vista de sólo lectura con todos los campos</div>
          </div>
        </div>
        <button id="btnRecargar" class="btn btn-acento">
          <i class="bi bi-arrow-repeat me-1"></i> Recargar
        </button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container" style="margin-top:-28px; margin-bottom:48px;">
    <div class="glass p-3 p-lg-4">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <strong class="text-muted">Resultados</strong>
        <span id="msg" class="small text-muted"></span>
      </div>

      <div class="table-responsive" style="max-height:70vh;">
        <table class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th class="th-small">ID</th>
              <th class="th-small">Año</th>
              <th class="th-small">Mes</th>
              <th class="th-small">F. presentación</th>
              <th class="th-small">F. cierre</th>
              <th class="th-small">Fecha</th>
              <th class="th-wide">Nº Licitación</th>
              <th class="th-wide">Empresa</th>
              <th class="th-wide">Descripción</th>
              <th class="th-small">SICOP</th>
              <th class="th-small">BMD</th>
              <th class="th-small">Encargado</th>
              <th class="th-small">Estado</th>
              <th class="th-small">Respuesta</th>
              <th class="th-small">Tipo</th>
              <th class="th-wide">Obs. iniciales</th>
              <th class="th-wide">Última observación</th>
              <th class="th-small">Creado</th>
              <th class="th-small">Actualizado</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="19" class="text-center py-4 text-muted">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== Usa el endpoint correcto: tabulacion_cargar.php =====
    // Si el PHP está en /API del mismo servidor que sirve el HTML:
    //   const API_CARGAR = '/API/tabulacion_cargar.php';
    // O si lo sirves desde Render (público):
    //   const API_CARGAR = 'https://licitaciones-5kie.onrender.com/API/tabulacion_cargar.php';
    const API_CARGAR = '/API/tabulacion_cargar.php';

    // ===== Utils
    const $ = (s, d=document)=>d.querySelector(s);
    function escapeHTML(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function fmtDate(v){ return v ? new Date(v+'T00:00:00').toLocaleDateString('es-CR') : '—'; }
    function fmtDateTime(v){ return v ? new Date(v).toLocaleString('es-CR') : '—'; }
    function fmtCRC(n){
      if(n===null || n===undefined || n==='') return '—';
      const num = Number(n);
      return isNaN(num) ? '—' : '₡ ' + num.toLocaleString('es-CR', {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    const MESES = ['','enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];

    // ===== Cargar tabla desde tabulacion_cargar.php
    async function cargarTabla(){
      const msg = $('#msg');
      const tb  = $('#tbody');
      msg.textContent = 'Cargando…';
      tb.innerHTML = `<tr><td colspan="19" class="text-center py-4 text-muted">Cargando…</td></tr>`;

      try{
        const r = await fetch(API_CARGAR);
        const ct = (r.headers.get('content-type') || '').toLowerCase();
        if(!ct.includes('application/json')){
          const text = await r.text();
          tb.innerHTML = `<tr><td colspan="19" class="text-danger small">
            Error: la API no devolvió JSON.<br><pre class="mb-0">${escapeHTML(text)}</pre></td></tr>`;
          msg.textContent = '';
          return;
        }
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.error || 'Error en la carga');

        // Soporta "rows" o "data"
        const rows = j.rows || j.data || [];
        if(!rows.length){
          tb.innerHTML = `<tr><td colspan="19" class="text-center py-4 text-muted">Sin resultados</td></tr>`;
          msg.textContent = '0 registros';
          return;
        }

        tb.innerHTML = '';
        rows.forEach(row=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.id}</td>
            <td>${row.anio ?? ''}</td>
            <td>${MESES[row.mes ?? 0] || row.mes || ''}</td>
            <td>${fmtDate(row.fecha_presentacion)}</td>
            <td>${fmtDate(row.fecha_cierre)}</td>
            <td>${fmtDate(row.fecha)}</td>
            <td class="truncate" title="${escapeHTML(row.numero_licitacion||'')}">${escapeHTML(row.numero_licitacion||'')}</td>
            <td class="truncate" title="${escapeHTML(row.empresa_solicitante||'')}">${escapeHTML(row.empresa_solicitante||'')}</td>
            <td class="truncate" title="${escapeHTML(row.descripcion||'')}">${escapeHTML(row.descripcion||'')}</td>
            <td>${fmtCRC(row.presupuesto_sicop)}</td>
            <td>${fmtCRC(row.presupuesto_bmd)}</td>
            <td>${escapeHTML(row.encargado||'')}</td>
            <td>${escapeHTML(row.estado||'')}</td>
            <td>${escapeHTML(row.respuesta||'')}</td>
            <td>${escapeHTML(row.tipo||'')}</td>
            <td class="truncate" title="${escapeHTML(row.observaciones_iniciales||'')}">${escapeHTML(row.observaciones_iniciales||'')}</td>
            <td class="truncate" title="${escapeHTML(row.ultima_observacion||'')}">${escapeHTML(row.ultima_observacion||'')}</td>
            <td>${fmtDateTime(row.creado_en)}</td>
            <td>${fmtDateTime(row.actualizado_en)}</td>
          `;
          tb.appendChild(tr);
        });
        msg.textContent = `${rows.length} registro(s)`;
      }catch(err){
        $('#tbody').innerHTML = `<tr><td colspan="19" class="text-danger small">⚠ ${escapeHTML(err.message||String(err))}</td></tr>`;
        msg.textContent = '';
      }
    }

    // Eventos
    $('#btnRecargar').addEventListener('click', cargarTabla);
    // Auto init
    cargarTabla();
  </script>
</body>
</html>
