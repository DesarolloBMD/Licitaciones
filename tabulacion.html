<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Licitaciones — Tabulación</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root{
      --acento:#0B4912;
      --acento-2:#126a1a;
      --bg-hero: radial-gradient(1200px 600px at 10% -10%, #d9f99d55, transparent 40%),
                 radial-gradient(1000px 600px at 90% -20%, #34d39933, transparent 45%),
                 linear-gradient(180deg,#0b0f24 0%, #0b0f24 40%, #0e132c 100%);
    }
    body{ background:#0b0f24; color:#0e1b2a; }
    .hero{ background:var(--bg-hero); color:#eaf2ff; padding:36px 0 56px; }
    .badge-soft{ background:#e8ffe8; color:#0b4912; border:1px solid #bde5bd; }
    .btn-acento{ background:var(--acento); color:#fff; border:none; }
    .btn-acento:hover{ filter:brightness(1.05); color:#fff; }
    .glass{ background:#fff; border:1px solid #e9edf3; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    table td, table th { vertical-align: top; }
    .table thead th{ white-space:nowrap; position:sticky; top:0; background:#f8fafc; z-index:2; }
    .table-responsive{ max-height:70vh; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>

  <!-- Encabezado -->
  <header class="hero">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          <span class="d-inline-flex align-items-center justify-content-center bg-success rounded-3"
                style="width:44px;height:44px;box-shadow:0 8px 24px rgba(16,185,129,.25)">
            <i class="bi bi-table text-white fs-5"></i>
          </span>
          <div>
            <h1 class="h4 m-0">Tabulación de Licitaciones</h1>
            <div class="text-white-50 small">Vista de solo lectura con todos los campos</div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="btnRecargar" class="btn btn-sm btn-acento"><i class="bi bi-arrow-repeat me-1"></i>Recargar</button>
          <span class="badge badge-soft rounded-pill px-3 py-2">
            <i class="bi bi-shield-lock me-2"></i>Sesión segura
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- Contenido -->
  <main class="container" style="margin-top:-30px; margin-bottom:48px;">
    <div class="p-3 p-lg-4 glass">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="h6 m-0 text-secondary">Registros</h2>
        <div id="msg" class="small text-muted"></div>
      </div>

      <div class="table-responsive border rounded-4">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Año</th>
              <th>Mes</th>
              <th>F. presentación</th>
              <th>F. cierre</th>
              <th>Fecha</th>
              <th>Nº Licitación</th>
              <th>Empresa</th>
              <th>Descripción</th>
              <th>SICOP</th>
              <th>BMD</th>
              <th>Encargado</th>
              <th>Estado</th>
              <th>Respuesta</th>
              <th>Tipo</th>
              <th>Obs. iniciales</th>
              <th>Última observación</th>
              <th>Creado</th>
              <th>Actualizado</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="19" class="text-center py-4">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== Config API: usa /api/ (minúsculas) =====
    const API_BASE   = '/api/';
    const API_CARGAR = API_BASE + 'tabulacion_cargar.php';

    const $ = (s, d=document)=>d.querySelector(s);

    function escapeHTML(s){
      return (s ?? '').toString().replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'
      }[m]));
    }
    function fmtMoney(v){
      const n = Number(v); if (Number.isNaN(n)) return '—';
      return '₡ ' + n.toLocaleString('es-CR',{minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function fmtDate(v){ return v ? new Date(v + 'T00:00:00').toLocaleDateString('es-CR') : '—'; }
    function fmtDateTime(v){ return v ? new Date(v).toLocaleString('es-CR') : '—'; }

    async function cargarTabla(){
      const msg = $('#msg');
      const tb  = $('#tbody');
      msg.textContent = 'Cargando…';
      tb.innerHTML = `<tr><td colspan="19" class="text-center py-4">Cargando…</td></tr>`;

      try{
        const r = await fetch(API_CARGAR, { cache:'no-store' });
        const ct = (r.headers.get('content-type') || '').toLowerCase();

        if(!ct.includes('application/json')){
          const text = await r.text();
          tb.innerHTML = `<tr><td colspan="19">
              <div class="alert alert-danger small mb-0">
                <div class="fw-semibold">Error: la API no devolvió JSON.</div>
                <pre class="mono mb-0" style="white-space:pre-wrap">${escapeHTML(text)}</pre>
              </div>
            </td></tr>`;
          msg.textContent = '';
          return;
        }

        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.error || 'Error en API');

        const rows = j.rows || [];
        if(!rows.length){
          tb.innerHTML = `<tr><td colspan="19" class="text-center py-4">Sin resultados</td></tr>`;
          msg.textContent = '0 registros';
          return;
        }

        tb.innerHTML = '';
        rows.forEach(row=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="mono">${row.id}</td>
            <td>${row.anio}</td>
            <td>${row.mes}</td>
            <td>${fmtDate(row.fecha_presentacion)}</td>
            <td>${fmtDate(row.fecha_cierre)}</td>
            <td>${fmtDate(row.fecha)}</td>
            <td class="mono">${escapeHTML(row.numero_licitacion)}</td>
            <td>${escapeHTML(row.empresa_solicitante||'')}</td>
            <td style="min-width:260px">${escapeHTML(row.descripcion||'')}</td>
            <td class="text-end">${fmtMoney(row.presupuesto_sicop)}</td>
            <td class="text-end">${fmtMoney(row.presupuesto_bmd)}</td>
            <td>${escapeHTML(row.encargado)}</td>
            <td>${escapeHTML(row.estado)}</td>
            <td>${escapeHTML(row.respuesta)}</td>
            <td>${escapeHTML(row.tipo)}</td>
            <td style="min-width:220px">${escapeHTML(row.observaciones_iniciales||'')}</td>
            <td style="min-width:220px">${escapeHTML(row.ultima_observacion||'')}</td>
            <td class="mono">${fmtDateTime(row.creado_en)}</td>
            <td class="mono">${fmtDateTime(row.actualizado_en)}</td>
          `;
          tb.appendChild(tr);
        });

        msg.textContent = `${rows.length} registro(s)`;
      }catch(err){
        $('#tbody').innerHTML = `<tr><td colspan="19">
          <div class="alert alert-danger small mb-0">⚠ ${escapeHTML(err.message||String(err))}</div>
        </td></tr>`;
        msg.textContent = '';
      }
    }

    document.getElementById('btnRecargar').addEventListener('click', cargarTabla);
    cargarTabla();
  </script>
</body>
</html>
