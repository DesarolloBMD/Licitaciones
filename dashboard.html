<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — Procedimientos Adjudicados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{ --acento:#0B4912; }
    body{ background:#0b0f24; }
    .wrap{ max-width:1200px; }
    .glass{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    .btn-acento{ background:var(--acento); color:#fff; border:none; }
    .btn-acento:hover{ filter:brightness(1.05); color:#fff; }
    .chip{ display:inline-block; padding:.15rem .5rem; border-radius:999px; background:#f1f5f9; margin:.15rem; cursor:pointer; }
    .tableFixHead{ overflow:auto; max-height:420px; }
    .tableFixHead thead th{ position:sticky; top:0; background:#fff; z-index:1; }
    code.small{ background:#f3f6fa; padding:.1rem .35rem; border-radius:.35rem; font-size:.85em; }
  </style>
</head>
<body class="py-4">
  <div class="container wrap">

    <!-- Filtros -->
    <div class="glass p-3 p-lg-4 mb-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <h1 class="h4 m-0 text-dark">Dashboard — Procedimientos Adjudicados</h1>
        <div class="text-muted small">Fuente: tabla <code class="small">"Procedimientos Adjudicados"</code></div>
      </div>

      <hr>

      <form id="filtros" class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Códigos (PROD_ID) — separados por coma</label>
          <input id="prodIds" type="text" class="form-control" placeholder="Ej: 80101508,80101513,14111526">
          <div class="form-text">Haz clic en un código sugerido para agregarlo:</div>
          <div id="chips" class="mt-1"></div>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Año de reporte</label>
          <select id="anio" class="form-select">
            <option value="">(Todos)</option>
          </select>
        </div>
        <div class="col-6 col-md-3 d-grid d-md-flex align-items-end gap-2">
          <button id="btnAplicar" type="submit" class="btn btn-acento">Aplicar filtros</button>
          <button id="btnLimpiar" type="button" class="btn btn-outline-secondary">Limpiar</button>
        </div>
      </form>
    </div>

    <!-- Totales -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-4">
        <div class="glass p-3">
          <div class="text-muted small">Total procedimientos</div>
          <div id="t_cnt" class="h3 m-0">–</div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="glass p-3">
          <div class="text-muted small">Suma Monto Adjudicado (CRC)</div>
          <div id="t_crc" class="h3 m-0">–</div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="glass p-3">
          <div class="text-muted small">Suma Monto Adjudicado (USD)</div>
          <div id="t_usd" class="h3 m-0">–</div>
        </div>
      </div>
    </div>

    <!-- Serie por Mes -->
    <div class="glass p-3 p-lg-4 mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h6 m-0">Montos por Mes de Descarga (CRC)</h2>
        <span id="loading" class="text-muted small d-none">Cargando…</span>
      </div>
      <canvas id="mesChart" height="120"></canvas>
    </div>

    <div class="row g-3">
      <!-- Top instituciones -->
      <div class="col-12 col-lg-6">
        <div class="glass p-3 p-lg-4 h-100">
          <h2 class="h6">Top instituciones (CRC)</h2>
          <div class="tableFixHead">
            <table class="table table-sm align-middle">
              <thead><tr><th>Institución</th><th class="text-end">Proced.</th><th class="text-end">CRC</th></tr></thead>
              <tbody id="tblInst"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Top proveedores -->
      <div class="col-12 col-lg-6">
        <div class="glass p-3 p-lg-4 h-100">
          <h2 class="h6">Top proveedores (CRC)</h2>
          <div class="tableFixHead">
            <table class="table table-sm align-middle">
              <thead><tr><th>Proveedor</th><th class="text-end">Proced.</th><th class="text-end">CRC</th></tr></thead>
              <tbody id="tblProv"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Resultados (detalle) -->
    <div class="glass p-3 p-lg-4 my-3">
      <div class="d-flex align-items-center justify-content-between">
        <h2 class="h6 m-0">Detalle (primeros 100)</h2>
        <div class="small text-muted" id="detalleInfo"></div>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-striped align-middle">
          <thead>
          <tr>
            <th>Mes</th>
            <th>Institución</th>
            <th>Proveedor</th>
            <th>PROD_ID</th>
            <th>Descripción</th>
            <th class="text-end">Monto CRC</th>
            <th class="text-end">Monto USD</th>
            <th class="text-end">Unitario</th>
          </tr>
          </thead>
          <tbody id="tblDetalle"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    const API = 'api/pa_dashboard.php';
    let chart;

    const $ = (s,d=document)=>d.querySelector(s);
    const fmt = n => new Intl.NumberFormat('es-CR').format(n ?? 0);
    const money = (n,cur) => (cur||'') + ' ' + fmt(Math.round((+n||0)));

    function setLoading(on){ $('#loading').classList.toggle('d-none', !on); }

    function chipsRender(list){
      const cont = $('#chips'); cont.innerHTML='';
      list.slice(0,50).forEach(({prod_id, cnt})=>{
        const el = document.createElement('span');
        el.className='chip';
        el.textContent = `${prod_id} (${cnt})`;
        el.dataset.code = prod_id;
        el.onclick = ()=>{
          const inp = $('#prodIds');
          const cur = inp.value.trim();
          inp.value = cur ? (cur + ',' + prod_id) : prod_id;
        };
        cont.appendChild(el);
      });
    }

    function tableSimple(tbodyId, rows, cols){
      const tb = $(tbodyId); tb.innerHTML='';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        cols.forEach(c=>{
          const td = document.createElement('td');
          if (c.align==='end') td.className='text-end';
          td.textContent = (typeof c.fn==='function') ? c.fn(r) : (r[c.key] ?? '');
          tr.appendChild(td);
        });
        tb.appendChild(tr);
      });
    }

    function renderChart(series){
      const labels = series.map(r=>r.mes);
      const data = series.map(r=>r.total_crc);
      if (chart) chart.destroy();
      chart = new Chart($('#mesChart'), {
        type:'bar',
        data:{ labels, datasets:[{ label:'CRC', data }] },
        options:{ responsive:true, plugins:{ legend:{display:false} } }
      });
    }

    async function fetchJSON(url){
      const r = await fetch(url);
      const tx = await r.text();
      let j; try{ j = JSON.parse(tx); } catch{ j = {ok:false,error:tx}; }
      if(!r.ok || !j.ok) throw new Error(j.error || 'Error de API');
      return j;
    }

    async function loadBase(){
      setLoading(true);
      try{
        const j = await fetchJSON(`${API}?action=boot`);
        // años
        const sel = $('#anio');
        (j.years||[]).forEach(y=>{
          const opt = document.createElement('option');
          opt.value = y; opt.textContent = y; sel.appendChild(opt);
        });
        // sugerencias PROD_ID
        chipsRender(j.top_prod_ids||[]);
      }catch(e){ console.error(e); }
      finally{ setLoading(false); }
    }

    async function applyFilters(e){
      e?.preventDefault();
      setLoading(true);
      const prod = $('#prodIds').value.split(',').map(s=>s.trim()).filter(Boolean).join(',');
      const year = $('#anio').value || '';
      try{
        const j = await fetchJSON(`${API}?prod_ids=${encodeURIComponent(prod)}&anio=${encodeURIComponent(year)}&limit=100`);
        // Totales
        $('#t_cnt').textContent = fmt(j.totales.count);
        $('#t_crc').textContent = money(j.totales.sum_crc,'₡');
        $('#t_usd').textContent = money(j.totales.sum_usd,'$');
        // Serie
        renderChart(j.serie_mes || []);
        // Top tablas
        tableSimple('#tblInst', j.top_inst || [], [
          {key:'INSTITUCION'},
          {fn:r=>fmt(r.cnt), align:'end'},
          {fn:r=>fmt(r.total_crc), align:'end'}
        ]);
        tableSimple('#tblProv', j.top_prov || [], [
          {key:'NOMBRE_PROVEEDOR'},
          {fn:r=>fmt(r.cnt), align:'end'},
          {fn:r=>fmt(r.total_crc), align:'end'}
        ]);
        // Detalle
        const det = j.detalle || [];
        $('#detalleInfo').textContent = det.length ? `${det.length} filas` : 'Sin datos';
        const tb = $('#tblDetalle'); tb.innerHTML='';
        det.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r["Mes de Descarga"] ?? ''}</td>
            <td>${r["INSTITUCION"] ?? ''}</td>
            <td>${r["NOMBRE_PROVEEDOR"] ?? ''}</td>
            <td>${r["PROD_ID"] ?? ''}</td>
            <td>${r["DESCR_BIEN_SERVICIO"] ?? ''}</td>
            <td class="text-end">${fmt(r["MONTO_ADJU_LINEA_CRC"] ?? 0)}</td>
            <td class="text-end">${fmt(r["MONTO_ADJU_LINEA_USD"] ?? 0)}</td>
            <td class="text-end">${fmt(r["MONTO_UNITARIO"] ?? 0)}</td>`;
          tb.appendChild(tr);
        });
      }catch(e){
        alert(e.message);
      }finally{
        setLoading(false);
      }
    }

    $('#filtros').addEventListener('submit', applyFilters);
    $('#btnLimpiar').addEventListener('click', ()=>{
      $('#prodIds').value=''; $('#anio').value=''; applyFilters();
    });

    loadBase().then(applyFilters);
  </script>
</body>
</html>
