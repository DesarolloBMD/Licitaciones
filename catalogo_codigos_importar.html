<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Importar “Catálogo de Códigos”</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root{ --bg:#0b0f24; --card:#ffffff; --ink:#0e1b2a; }
    body{ background:var(--bg); color:#eaf2ff; }
    .card{ background:var(--card); color:var(--ink); border-radius:16px; }
    code{ background:#eef4ff; padding:.15rem .35rem; border-radius:.35rem; }
    .progress{ height:8px; }
    pre.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; white-space:pre-wrap; }
  </style>
</head>
<body class="p-3 p-lg-5">

<div class="container" style="max-width:980px">
  <header class="mb-4">
    <h1 class="h4 m-0">Importar “Catálogo de Códigos”</h1>
    <div class="text-white-50 small">
      Cargue un archivo <code>.csv</code>, <code>.tsv</code> o <code>.txt</code> con encabezados:
      <code>Tipo de Clasificación</code>, <code>Codigo de Clasificación</code>, <code>Descripción de Clasificación</code>.
    </div>
  </header>

  <!-- Card: Uploader -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form id="frm" class="vstack gap-3" enctype="multipart/form-data">
        <div>
          <label class="form-label">Archivo (.csv, .tsv o .txt) con encabezados</label>
          <input class="form-control" type="file" name="archivo" id="archivo" accept=".csv,.tsv,.txt" required />
          <div class="form-text">
            Separador soportado: <code>,</code>, <code>;</code> o <code>(tab)</code> (auto-detectado).
          </div>
        </div>

        <!-- Botones + cronómetro -->
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <button class="btn btn-success" id="btnUpload" type="submit">
            <i class="bi bi-cloud-arrow-up me-1"></i> Subir e importar
          </button>
          <button class="btn btn-outline-danger" id="btnCancel" type="button" disabled>
            <i class="bi bi-x-circle me-1"></i> Cancelar
          </button>
          <button class="btn btn-outline-secondary" id="btnReset" type="reset">
            <i class="bi bi-eraser me-1"></i> Limpiar
          </button>
          <span id="timerWrap" class="small text-muted ms-auto d-none">
            <i class="bi bi-stopwatch"></i> Duración: <span id="timer">00:00</span>
          </span>
        </div>

        <div class="progress d-none" id="pgwrap">
          <div class="progress-bar bg-success" id="bar" style="width:0%"></div>
        </div>

        <div id="msg" class="small"></div>
        <pre id="raw" class="mono small d-none p-2 bg-light border rounded"></pre>
      </form>
    </div>
  </div>

  <!-- Card: Historial -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0">Historial de importaciones</h2>
        <button class="btn btn-sm btn-outline-primary" id="btnReload">
          <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Archivo</th>
              <th class="text-end">Filas</th>
              <th class="text-end">Insert/Upd</th>
              <th class="text-end">Saltadas</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody id="logs">
            <tr><td colspan="6" class="text-muted">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // ⇢ Ajusta esta ruta si tu PHP está en otra carpeta
  const ENDPOINT = 'api/catalogo_codigos_importar.php';
  const $ = (s, d=document)=>d.querySelector(s);
  const esc = s => (s??'').toString().replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));

  // ------- Historial -------
  async function loadLogs(){
    try{
      const r = await fetch(ENDPOINT + '?accion=logs');
      const j = await r.json();
      const tb = $('#logs');
      if(!j.ok){ tb.innerHTML = `<tr><td colspan="6" class="text-danger">Error: ${esc(j.error||'')}</td></tr>`; return; }
      if(!j.logs.length){ tb.innerHTML = `<tr><td colspan="6" class="text-muted">Sin importaciones aún.</td></tr>`; return; }
      tb.innerHTML = j.logs.map(row=>{
        const fecha = new Date(row.started_at).toLocaleString();
        const btn = row.anulado_at
          ? `<button class="btn btn-sm btn-outline-secondary" disabled>Anulado</button>`
          : `<button class="btn btn-sm btn-outline-danger" data-id="${row.import_id}" onclick="anular(this)">Anular</button>`;
        return `<tr>
          <td>${esc(fecha)}</td>
          <td>${esc(row.filename||'')}</td>
          <td class="text-end">${row.total_rows ?? ''}</td>
          <td class="text-end">${row.inserted ?? ''}</td>
          <td class="text-end">${row.skipped ?? ''}</td>
          <td class="text-end">${btn}</td>
        </tr>`;
      }).join('');
    }catch(e){
      $('#logs').innerHTML = `<tr><td colspan="6" class="text-danger">Error cargando historial</td></tr>`;
    }
  }
  async function anular(btn){
    const id = btn.getAttribute('data-id');
    if(!confirm('¿Anular esta importación? Se eliminarán solo las filas de ese archivo.')) return;
    btn.disabled = true;
    const fd = new FormData(); fd.append('accion','anular'); fd.append('import_id', id);
    const r = await fetch(ENDPOINT, {method:'POST', body:fd});
    const j = await r.json();
    if(!j.ok) alert('Error: ' + (j.error || ''));
    loadLogs();
  }
  $('#btnReload').addEventListener('click', loadLogs);

  // ------- Progreso & Cronómetro -------
  let controller=null, fakeTimer=null, timerId=null, t0=0;

  const setProgress = p => { $('#pgwrap').classList.remove('d-none'); $('#bar').style.width = p + '%'; };
  function startFake(){ let p=5; setProgress(p); fakeTimer=setInterval(()=>{ p=Math.min(p+Math.random()*4+1,85); setProgress(Math.round(p)); if(p>=85){stopFake();}},350); }
  const stopFake = ()=>{ if(fakeTimer){ clearInterval(fakeTimer); fakeTimer=null; } };

  const fmt = ms => { const s=Math.floor(ms/1000), m=Math.floor(s/60); return String(m).padStart(2,'0')+':'+String(s%60).padStart(2,'0'); };
  function startTimer(){ t0=Date.now(); $('#timerWrap').classList.remove('d-none'); $('#timer').textContent='00:00';
    timerId=setInterval(()=>{ $('#timer').textContent=fmt(Date.now()-t0); },500); }
  function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }

  // ------- Subida -------
  $('#frm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const file = $('#archivo').files[0];
    if(!file){ $('#msg').textContent = 'Seleccione un archivo.'; return; }

    $('#btnUpload').disabled = true;
    $('#btnCancel').disabled = false;
    $('#msg').textContent = 'Subiendo…';
    $('#raw').classList.add('d-none');
    startFake();
    startTimer();

    controller = new AbortController();
    const fd = new FormData(); fd.append('archivo', file);

    try{
      const r = await fetch(ENDPOINT, {method:'POST', body:fd, signal:controller.signal});
      stopFake(); setProgress(100); stopTimer();
      const raw = await r.text();
      let j; try{ j = JSON.parse(raw); } catch{ j = { ok:false, error: raw }; }

      if(!r.ok || !j.ok){
        $('#msg').innerHTML = '⚠ ' + esc(j.error || 'Error');
        $('#raw').classList.remove('d-none'); $('#raw').textContent = raw;
      }else{
        $('#msg').innerHTML = `✅ Importación completada. Insert/Upd: <strong>${j.insertados}</strong> — Saltados: <strong>${j.saltados}</strong>`;
        loadLogs();
      }
    }catch(err){
      stopFake(); stopTimer();
      $('#msg').textContent = (err.name === 'AbortError') ? '⛔ Importación cancelada.' : ('⚠ ' + (err.message || String(err)));
    }finally{
      $('#btnUpload').disabled = false;
      $('#btnCancel').disabled = true;
      controller = null;
    }
  });

  // Cancelar
  $('#btnCancel').addEventListener('click', ()=>{
    if(controller){ controller.abort(); }
  });

  // Limpiar (RESET)
  $('#frm').addEventListener('reset', ()=>{
    if(controller){ controller.abort(); }
    stopFake(); stopTimer();
    $('#msg').textContent = '';
    $('#raw').textContent = '';
    $('#raw').classList.add('d-none');
    $('#bar').style.width='0%';
    $('#pgwrap').classList.add('d-none');
    $('#timerWrap').classList.add('d-none');
  });

  loadLogs();
</script>
</body>
</html>
