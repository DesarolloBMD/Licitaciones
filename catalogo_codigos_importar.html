<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gestión de Licitaciones — Importar Catálogo de Códigos</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root{ --acento:#0B4912; }
    body{ background:#0b0f24; }
    .hero{ background:linear-gradient(180deg,#0b0f24 0%, #0e132c 100%); color:#eaf2ff; padding:48px 0 56px; }
    .glass{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    .btn-acento{ background:var(--acento); color:#fff; border:none; }
    .btn-acento:hover{ filter:brightness(1.05); color:#fff; }
    .small-muted{ color:#6b7b91; font-size:.92rem; }
    .progress{ height:8px; }
    pre.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; white-space:pre-wrap; }
  </style>
</head>
<body>

<header class="hero">
  <div class="container">
    <div class="d-flex align-items-center gap-3">
      <span class="d-inline-flex align-items-center justify-content-center bg-success rounded-3"
            style="width:48px;height:48px;box-shadow:0 8px 24px rgba(16,185,129,.25)">
        <i class="bi bi-journal-arrow-up text-white fs-4"></i>
      </span>
      <div>
        <h1 class="h4 m-0">Importar <em>Catálogo de Códigos</em></h1>
        <div class="text-white-50 small">Cargue un archivo .csv, .tsv o .txt con los encabezados requeridos</div>
      </div>
    </div>
  </div>
</header>

<main class="container" style="margin-top:-36px;margin-bottom:64px;">
  <div class="glass p-3 p-lg-4">
    <form id="frm" class="vstack gap-3" enctype="multipart/form-data" novalidate>
      <div class="row g-3">
        <div class="col-12 col-lg-8">
          <label class="form-label">Archivo (.csv, .tsv o .txt) con encabezados</label>
          <input class="form-control" type="file" name="archivo" id="archivo" accept=".csv,.tsv,.txt" required />
          <div class="form-text small-muted">
            Separadores soportados: <code>,</code>, <code>;</code> o <code>(tab)</code> (auto-detectado).<br/>
            Encabezados esperados (en cualquier mayúsculas/minúsculas/acentos):<br/>
            <code>Tipo de Clasificación</code>, <code>Codigo de Clasificación</code>, <code>Descripción de Clasificación</code>.
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <label class="form-label">Opciones</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="tieneHeader" checked>
            <label class="form-check-label" for="tieneHeader">Primera fila contiene encabezados</label>
          </div>
          <div class="small text-muted mt-2">
            Este importador realiza <strong>upsert</strong>: si el par
            <em>(Tipo de Clasificación, Código)</em> ya existe, actualiza la
            <em>Descripción</em>.
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-acento" id="btnEnviar" type="submit">
          <i class="bi bi-cloud-arrow-up me-1"></i> Subir e importar
        </button>
        <button class="btn btn-outline-danger" type="button" id="btnCancelar" disabled>
          <i class="bi bi-x-circle me-1"></i> Cancelar
        </button>
        <button class="btn btn-outline-secondary" type="reset" id="btnReset">
          <i class="bi bi-eraser me-1"></i> Limpiar
        </button>
      </div>

      <div class="d-none" id="pgwrap">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <small class="text-muted">Progreso</small>
          <small class="text-muted">
            <span id="pct">0%</span>
            <span class="ms-2" id="elapsed" title="Duración">00:00</span>
          </small>
        </div>
        <div class="progress">
          <div class="progress-bar bg-success" id="bar" style="width:0%"></div>
        </div>
      </div>

      <div id="msg" class="small"></div>
      <div id="res" class="mt-2 small"></div>
      <pre id="raw" class="mono small d-none p-2 bg-light border rounded"></pre>
    </form>
  </div>
</main>

<script>
  const API_URL = 'api/catalogo_codigos_importar.php';
  const $ = (s,d=document)=>d.querySelector(s);

  let controller = null;
  let fakeTimer = null;
  let t0 = 0, tick = null;

  function escapeHTML(s){ return (s ?? '').toString().replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function setProgress(p){ $('#pgwrap').classList.remove('d-none'); $('#bar').style.width = p + '%'; $('#pct').textContent = p + '%'; }
  function fmt(sec){ const m = Math.floor(sec/60), s = Math.floor(sec%60); return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
  function startElapsed(){ t0 = Date.now(); $('#elapsed').textContent = '00:00'; tick = setInterval(()=>{ $('#elapsed').textContent = fmt((Date.now()-t0)/1000); }, 250); }
  function stopElapsed(){ if(tick){ clearInterval(tick); tick=null; } }
  function startFakeProgress(){ let p=5; setProgress(p); fakeTimer=setInterval(()=>{ p = Math.min(p + Math.random()*4 + 1, 85); setProgress(Math.round(p)); if(p>=85){ clearInterval(fakeTimer); fakeTimer=null; } }, 400); }
  function stopFakeProgress(){ if(fakeTimer){ clearInterval(fakeTimer); fakeTimer=null; } }

  $('#frm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const file = $('#archivo').files[0];
    if(!file){ $('#msg').textContent = 'Seleccione un archivo.'; return; }

    const fd = new FormData();
    fd.append('archivo', file);
    fd.append('tiene_header', $('#tieneHeader').checked ? '1' : '0');

    controller = new AbortController();
    $('#btnEnviar').disabled = true;
    $('#btnCancelar').disabled = false;
    $('#msg').textContent = 'Subiendo…';
    $('#res').textContent = '';
    $('#raw').classList.add('d-none');

    startFakeProgress();
    startElapsed();

    try{
      const r = await fetch(API_URL, { method:'POST', body: fd, signal: controller.signal });
      stopFakeProgress(); setProgress(100); stopElapsed();

      // leer siempre como texto y luego intentar JSON
      const raw = await r.text(); let j;
      try { j = JSON.parse(raw); } catch { j = { ok:false, error: raw }; }

      if(!r.ok || !j.ok){
        $('#msg').innerHTML = '⚠ Error: ' + escapeHTML(j.error || 'desconocido');
        if (j.debug){
          $('#raw').classList.remove('d-none'); $('#raw').innerHTML = escapeHTML(j.debug);
        } else if (typeof j.error === 'string' && j.error.trim().startsWith('<')){
          $('#raw').classList.remove('d-none'); $('#raw').innerHTML = escapeHTML(j.error);
        }
        return;
      }

      $('#msg').innerHTML = '✅ Importación completada';
      const errs = Array.isArray(j.errores) ? j.errores.length : (j.errores ?? 0);
      const ins  = j.insertados ?? 0;
      const upd  = j.actualizados ?? 0;
      const skip = j.saltados ?? 0;

      $('#res').innerHTML =
        `<div class="alert alert-success mt-2">
           Insertados: <strong>${ins}</strong> — Actualizados: <strong>${upd}</strong> — Saltados: <strong>${skip}</strong> — Errores: <strong>${errs}</strong>
         </div>` +
        (Array.isArray(j.errores) && j.errores.length
          ? `<details class="mt-2"><summary>Errores (${j.errores.length})</summary><pre class="mono">${escapeHTML(j.errores.slice(0,50).join('\n'))}${j.errores.length>50?'\n...':''}</pre></details>`
          : '');

    }catch(err){
      stopFakeProgress(); stopElapsed();
      $('#msg').textContent = (err.name === 'AbortError') ? '⛔ Importación cancelada por el usuario.' : ('⚠ ' + (err.message || String(err)));
    }finally{
      $('#btnEnviar').disabled = false;
      $('#btnCancelar').disabled = true;
      controller = null;
    }
  });

  $('#btnCancelar').addEventListener('click', ()=>{ if(controller){ controller.abort(); } });
  $('#btnReset').addEventListener('click', ()=>{
    $('#msg').textContent = ''; $('#res').textContent = ''; $('#raw').textContent = ''; $('#raw').classList.add('d-none');
    stopFakeProgress(); stopElapsed(); $('#bar').style.width='0%'; $('#pct').textContent='0%'; $('#elapsed').textContent='00:00'; $('#pgwrap').classList.add('d-none');
  });
</script>
</body>
</html>
