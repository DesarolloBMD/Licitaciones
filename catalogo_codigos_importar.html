<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catálogo de Códigos — Importar</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{ --acento:#0B4912; }
    body{ background:#0b0f24; color:#eaf2ff; }
    .hero{ background:linear-gradient(180deg,#0b0f24 0%, #0e132c 100%); color:#eaf2ff; padding:40px 0 48px; }
    .glass{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); color:#0e1b2a; }
    .btn-acento{ background:var(--acento); color:#fff; border:none; }
    .btn-acento:hover{ filter:brightness(1.05); color:#fff; }
    .small-muted{ color:#6b7b91; font-size:.9rem; }
    code{ background:#f3f6fa; padding:.15rem .35rem; border-radius:.35rem; }
    .progress{ height:8px; }
    pre.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; white-space:pre-wrap; }
  </style>
</head>
<body>

<header class="hero">
  <div class="container">
    <h1 class="h4 m-0">Importar “Catálogo de Códigos”</h1>
    <div class="text-white-50 small">
      Cargue un archivo <code>.csv</code>, <code>.tsv</code> o <code>.txt</code> con encabezados:
      <code>Tipo de Clasificación</code>, <code>Codigo de Clasificación</code>, <code>Descripción de Clasificación</code>.
    </div>
  </div>
</header>

<main class="container" style="margin-top:-28px;margin-bottom:64px;">
  <!-- CARGA -->
  <div class="glass p-3 p-lg-4 mb-4">
    <form id="frm" class="vstack gap-3" enctype="multipart/form-data">
      <div>
        <label class="form-label">Archivo (.csv, .tsv o .txt)</label>
        <input class="form-control" type="file" name="archivo" id="archivo" accept=".csv,.tsv,.txt" required />
        <div class="form-text small-muted">
          Separador soportado: <code>,</code>, <code>;</code> o <code>(tab)</code> (auto-detectado).
        </div>
      </div>

      <!-- Botones debajo del input -->
      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-acento" id="btnEnviar" type="submit">
          Subir e importar
        </button>
        <button class="btn btn-outline-danger" type="button" id="btnCancelar" disabled>
          Cancelar
        </button>
      </div>

      <!-- Progreso + Cronómetro -->
      <div class="d-none" id="pgwrap">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <small class="text-muted">Progreso</small>
          <div class="d-flex align-items-center gap-3">
            <small class="text-muted">Tiempo: <span id="timer">00:00</span></small>
            <small class="text-muted" id="pct">0%</small>
          </div>
        </div>
        <div class="progress">
          <div class="progress-bar bg-success" id="bar" style="width:0%"></div>
        </div>
      </div>

      <div id="msg" class="small"></div>
      <div id="res" class="mt-2 small"></div>
      <pre id="raw" class="mono small d-none p-2 bg-light border rounded"></pre>
    </form>
  </div>

  <!-- HISTORIAL -->
  <div class="glass p-3 p-lg-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0">Historial de importaciones</h2>
      <button class="btn btn-sm btn-outline-primary" id="btnReload">Actualizar</button>
    </div>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="min-width:160px;">Fecha</th>
            <th>Archivo</th>
            <th class="text-end">Filas</th>
            <th class="text-end">Insert/Upd</th>
            <th class="text-end">Saltadas</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody id="logs">
          <tr><td colspan="6" class="text-muted">Cargando…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<script>
  const ENDPOINT = 'api/catalogo_codigos_importar.php';
  const $ = (s,d=document)=>d.querySelector(s);

  let controller=null, fakeTimer=null, tInterval=null, tStart=null;

  function esc(s){ return (s??'').toString().replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }
  function setProgress(p){ $('#pgwrap').classList.remove('d-none'); $('#bar').style.width=p+'%'; $('#pct').textContent=p+'%'; }
  function startFakeProgress(){
    let p=5; setProgress(p);
    fakeTimer=setInterval(()=>{ p=Math.min(p+Math.random()*4+1,85); setProgress(Math.round(p)); if(p>=85){clearInterval(fakeTimer); fakeTimer=null;} }, 350);
  }
  function stopFakeProgress(){ if(fakeTimer){ clearInterval(fakeTimer); fakeTimer=null; } }

  function fmt(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const ss=String(s%60).padStart(2,'0'); return String(m).padStart(2,'0')+':'+ss; }
  function startTimer(){ tStart=Date.now(); $('#timer').textContent='00:00'; tInterval=setInterval(()=>{ $('#timer').textContent=fmt(Date.now()-tStart); },250); }
  function stopTimer(){ if(tInterval){ clearInterval(tInterval); tInterval=null; } }

  async function loadLogs(){
    try{
      const r = await fetch(`${ENDPOINT}?accion=logs`);
      const j = await r.json();
      const tb = $('#logs');
      if(!j.ok){ tb.innerHTML = `<tr><td colspan="6" class="text-danger">Error: ${esc(j.error||'')}</td></tr>`; return; }
      if(!j.logs.length){ tb.innerHTML = `<tr><td colspan="6" class="text-muted">Sin importaciones aún.</td></tr>`; return; }
      tb.innerHTML = j.logs.map(row=>{
        const fecha  = row.started_at ? new Date(row.started_at).toLocaleString() : '';
        const btn = row.anulado_at
          ? `<button class="btn btn-sm btn-outline-secondary" disabled>Anulado</button>`
          : `<button class="btn btn-sm btn-outline-danger" data-id="${row.import_id}" onclick="anular(this)">Anular</button>`;
        return `<tr>
          <td>${esc(fecha)}</td>
          <td>${esc(row.filename||'')}</td>
          <td class="text-end">${row.total_rows ?? ''}</td>
          <td class="text-end">${row.inserted ?? ''}</td>
          <td class="text-end">${row.skipped ?? ''}</td>
          <td class="text-end">${btn}</td>
        </tr>`;
      }).join('');
    }catch(e){
      $('#logs').innerHTML = `<tr><td colspan="6" class="text-danger">Error al cargar: ${esc(e.message||String(e))}</td></tr>`;
    }
  }

  async function anular(btn){
    const id = btn.getAttribute('data-id');
    if(!confirm('¿Anular esta importación? Se eliminarán solo las filas de ese archivo.')) return;
    btn.disabled = true;
    const fd = new FormData(); fd.append('accion','anular'); fd.append('import_id', id);
    const r = await fetch(ENDPOINT, {method:'POST', body:fd});
    const j = await r.json();
    if(!j.ok) alert('Error: '+(j.error||''));
    await loadLogs();
  }

  $('#btnReload').addEventListener('click', loadLogs);

  // Envío del archivo
  $('#frm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const file = $('#archivo').files[0];
    if(!file){ $('#msg').textContent = 'Seleccione un archivo.'; return; }
    const fd = new FormData(); fd.append('archivo', file);

    controller = new AbortController();
    $('#btnEnviar').disabled = true;
    $('#btnCancelar').disabled = false;
    $('#msg').textContent = 'Subiendo…';
    $('#res').textContent = '';
    $('#raw').classList.add('d-none');
    startFakeProgress();
    startTimer();

    try{
      const r = await fetch(ENDPOINT, { method:'POST', body: fd, signal: controller.signal });
      stopFakeProgress(); stopTimer(); setProgress(100);

      const raw = await r.text();
      let j; try{ j = JSON.parse(raw); } catch{ j = { ok:false, error: raw }; }

      if(!r.ok || !j.ok){
        $('#msg').innerHTML = '⚠ ' + esc(j.error || 'Error desconocido');
        $('#raw').classList.remove('d-none');
        $('#raw').textContent = raw;
        return;
      }

      $('#msg').innerHTML = '✅ Importación completada';
      $('#res').innerHTML =
        `<div class="alert alert-success mt-2">
           Insert/Upd: <strong>${j.insertados}</strong> — Saltadas: <strong>${j.saltados}</strong> — Total leídas: <strong>${j.total}</strong>
         </div>`;

      await loadLogs();

    }catch(err){
      stopFakeProgress(); stopTimer();
      if(err.name === 'AbortError'){
        $('#msg').textContent = '⛔ Importación cancelada por el usuario.';
      }else{
        $('#msg').textContent = '⚠ ' + (err.message || String(err));
      }
    }finally{
      $('#btnEnviar').disabled = false;
      $('#btnCancelar').disabled = true;
      controller = null;
    }
  });

  // Cancelar
  $('#btnCancelar').addEventListener('click', ()=>{
    if(controller){ controller.abort(); }
  });

  // Inicial
  loadLogs();
</script>
</body>
</html>
